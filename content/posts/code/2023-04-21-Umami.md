---
title: "Umami Docker éƒ¨ç½²åŠä¼˜åŒ–"
images: ["/assets/images/og/umami.png"]
authors: ["eallion"]
categories: ["ä»£ç "]
tags:
  - umami
  - blog
slug: "umami"
summary: "è¿™ç¯‡æ–‡ç« ä»‹ç»äº†Umami Dockerçš„éƒ¨ç½²å’Œä¼˜åŒ–ã€‚ä½œè€…é¦–å…ˆä»‹ç»äº†Umamiæ˜¯ä¸€ä¸ªå¼€æºçš„è‡ªæ‰˜ç®¡çš„è½»é‡çº§ç½‘ç«™ç»Ÿè®¡åˆ†æå·¥å…·ï¼Œé€‚ç”¨äºä¸ªäººåšå®¢å’Œå°å‹ç½‘ç«™ã€‚ç„¶åï¼Œä½œè€…æä¾›äº†å®‰è£…Umamiçš„æ­¥éª¤ï¼ŒåŒ…æ‹¬å®‰è£…Nginxã€æ·»åŠ è¢«ç»Ÿè®¡çš„ç½‘ç«™å’Œè·å–è·Ÿè¸ªä»£ç ã€‚æ¥ç€ï¼Œä½œè€…æä¾›äº†ä¸‰ç§ä¼˜åŒ–ç­–ç•¥ï¼šå¹¿å‘Šæ’ä»¶åå±è”½ã€å°†è·Ÿè¸ªä»£ç éƒ¨ç½²åˆ°è‡ªå·±çš„CDNå’Œå¦‚ä½•é›†æˆåˆ°APIã€‚æœ€åï¼Œä½œè€…ä»‹ç»äº†Nginxåå‘ä»£ç†çš„è®¾ç½®å’Œå¦‚ä½•åœ¨é™æ€åšå®¢ä¸­ä½¿ç”¨Umamiã€‚"
draft: false
comment: 
  enable: true
date: 2023-04-21T22:12:55+08:00
---

[Umami](https://umami.is/) æ˜¯ä¸€ä¸ªå¼€æºçš„ Self-hosted çš„è½»é‡ç½‘ç«™ç»Ÿè®¡åˆ†æå·¥å…·ã€‚å¯æ›¿ä»£ Google Analyticsã€ç™¾åº¦ç»Ÿè®¡è¿™äº›å·¥å…·ã€‚é€‚åˆä¸ªäººåšå®¢ã€å°å‹ç½‘ç«™ä½¿ç”¨ã€‚

æœ¬åšå®¢å·²ç¨³å®šä½¿ç”¨ Umami ä¸¤å¹´å¤šã€‚ç°åœ¨æ­£å€¼ Umami å¤§å‡çº§åˆ° 2.0 ç‰ˆæœ¬ã€‚å› ä¸ºæ˜¯ä¸ªäººç½‘ç«™ï¼Œç»Ÿè®¡æ•°æ®å¹¶ä¸æ˜¯é‚£ä¹ˆé‡è¦ï¼Œç´¢æ€§æˆ‘å°±å…¨æ–°å®‰è£…äº† Umamiï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹å®‰è£…è¿‡ç¨‹ï¼Œå¤‡å¿˜åŠåˆ†äº«ã€‚ç›®å‰å·²å‘å¸ƒ 2.0.1 ç‰ˆæœ¬ï¼Œä¿®å¤äº†ä¸€äº› BUGã€‚

å¦‚æœéœ€è¦ä¿ç•™æ•°æ®å‡çº§ Umamiï¼Œè¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š<https://umami.is/docs/migrate-v1-v2>

> **ä¼˜åŒ–** éƒ¨åˆ†åœ¨æ–‡æœ«ã€‚

### å®‰è£…

> æœåŠ¡å™¨æœ‰ Node.js è¿è¡Œæ—¶çš„ï¼Œå¯ä»¥å®‰è£… Node.js ç‰ˆæœ¬ã€‚å®˜ç½‘æœ‰æ–‡æ¡£ä»‹ç»ï¼Œåœ¨æ­¤ç•¥è¿‡ã€‚

æ¨èä½¿ç”¨ Docker å®‰è£…ã€‚

åœ¨åŸŸåç›®å½•ä¸‹æ–°å»º `docker-compose.yml`æ–‡ä»¶ï¼š

```bash
vim docker-compose.yml
```

**æ³¨æ„**ï¼šä¸­å›½å¤§é™†çš„æœåŠ¡å™¨å¯èƒ½æ‰“ä¸å¼€å®˜æ–¹ç¤ºä¾‹ä¸­çš„ `ghcr.io` åŸŸåï¼Œè¿™é‡Œæ”¹ä¸ºäº†`docker.umami.dev`

```yaml
---
version: '3'
services:
  umami:
    image: docker.umami.dev/umami-software/umami:postgresql-latest
    ports:
      - "3000:3000"
    environment:
      DATABASE_URL: postgresql://umami:umami@db:5432/umami
      DATABASE_TYPE: postgresql
      APP_SECRET: replace-me-with-a-random-string
      TRACKER_SCRIPT_NAME: random-string.js
    depends_on:
      - db
    restart: always
  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: umami
      POSTGRES_USER: umami
      POSTGRES_PASSWORD: umami
    volumes:
      - ./sql/schema.postgresql.sql:/docker-entrypoint-initdb.d/schema.postgresql.sql:ro
      - umami-db-data:/var/lib/postgresql/data
    restart: always
volumes:
  umami-db-data:
```

åŸºæœ¬ä¸Šä¸ç”¨ä¿®æ”¹ä»€ä¹ˆï¼Œåªéœ€è¦æ³¨æ„ç«¯å£æ˜¯å¦å ç”¨ã€‚å¦‚æœç«¯å£è¢«å ç”¨ï¼ŒæŠŠ`ports`ä¸­å†’å·å‰çš„`3000`æ”¹ä¸ºå…¶ä»–çš„ã€‚

å¯ç”¨ Docker å®¹å™¨ï¼š

```bash
docker compose up -d
```

æ­¤æ—¶ï¼Œæ‰“å¼€ `http://server_ip:3000`å³å¯ç™»å½• Umami å¼€å§‹ä½¿ç”¨äº†ã€‚

- é»˜è®¤è´¦å·ï¼š`admin`
- é»˜è®¤å¯†ç ï¼š`umami`

### Nginx åä»£

å¦‚æœä¸æƒ³ç›´æ¥ä½¿ç”¨æœåŠ¡å™¨çš„ IP ç™»å½•å’Œæš´éœ²ç«¯å£ï¼Œå¯ä»¥åˆ©ç”¨ Nginx åä»£ã€‚å‡è®¾ä½¿ç”¨ `tongji.notumami.com` è¿™ä¸ªäºŒçº§åŸŸåæ¥å½“ä½œ Umami çš„åŸŸåã€‚

åä»£é…ç½®ï¼š

```
server
{
    listen 80;
	listen 443 ssl http2;
    server_name tongji.notumami.com;
    root /www/wwwroot/tongji.notumami.com;
    if ($server_port !~ 443){
        rewrite ^(/.*)$ https://$host$1 permanent;
    }

    ####################
    # å…¶ä»–é…ç½®
    ####################

    # åä»£é…ç½®
    location ^~ /   {
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header REMOTE-HOST $remote_addr;
    add_header X-Cache $upstream_cache_status;
    # ç¼“å­˜
    add_header Cache-Control no-cache;
    expires 12h;
  }
}
```

å®å¡”é¢æ¿åä»£è®¾ç½®ï¼š

![](/assets/images/posts/2023/04/umami_bt.png)

é…ç½® Nginx åä»£åï¼Œå°±å¯ä»¥é€šè¿‡åŸŸåç™»å½• Umami äº†ã€‚å¦‚ï¼š`https://tongji.notumami.com`

### æ·»åŠ è¢«ç»Ÿè®¡ç½‘ç«™

é€šè¿‡åŸŸå `https://tongji.notumami.com` ç™»å½• Umami åå°ã€‚
åœ¨è®¾ç½®ä¸­æ·»åŠ éœ€è¦è¢«ç»Ÿè®¡çš„ç½‘ç«™ï¼Œå…ˆç‚¹ğŸŒåœ°çƒå›¾æ ‡ï¼Œåˆ‡æ¢ä¸ºä¸­æ–‡ã€‚å†ç‚¹`è®¾ç½®`ï¼Œ`æ·»åŠ ç½‘ç«™`ï¼š

![](/assets/images/posts/2023/04/umami_add_site.png)

### è·å–è·Ÿè¸ªä»£ç 

åœ¨åˆšæ‰æ·»åŠ çš„ç½‘ç«™ä¸Šç‚¹å‡»`ç¼–è¾‘`ï¼Œ`è·Ÿè¸ªä»£ç `ï¼Œå°±èƒ½è·å–åˆ°è·Ÿè¸ªä»£ç äº†ï¼š

```html
<script
    async
    src="https://tongji.notumami.com/random-string.js"
    data-website-id="cbd4s67a-82e8-481d-9104-a0e3815466f0">
</script>
```

![](/assets/images/posts/2023/04/umami_get_analytics_code.png)

### å®‰è£…è·Ÿè¸ªä»£ç 

åˆ°éœ€è¦è¢«ç»Ÿè®¡çš„ç½‘ç«™ä¸Šï¼Œæ‰¾ä¸€ä¸ªåˆé€‚çš„ä½ç½®ï¼Œç²˜è´´ä¸Šé¢è·å–åˆ°çš„è·Ÿè¸ªä»£ç å³å¯ä½¿ç”¨ã€‚

ä¸€äº›é™æ€åšå®¢ Hexoã€Hugo çš„ä¸»é¢˜å·²ç»æ”¯æŒ Umami äº†ï¼Œåªéœ€è¦åœ¨ä¸»é¢˜çš„ `config` ä¸­é…ç½®å³å¯ã€‚
æ¯”å¦‚æœ¬åšå®¢ç”¨çš„ DoIt ä¸»é¢˜çš„ [`config.toml`](https://github.com/eallion/eallion.com/blob/7a21a68f4447aa2256ce983ebc01b06ef07c2401/config.toml#L1039-L1044) é…ç½®ï¼š

```toml
    # Umami Analytics
    [params.analytics.umami]
      data_website_id = "cbd4a55a-81e8-42ed-5d04-a0e2315433f0"
      src = "https://api.eallion.com/umami/69d6ffe.js?v=2.0.1"
      data_host_url ="https://a.eallion.com"
      data_domains = "eallion.com,www.eallion.com"
```

### ä¼˜åŒ–

#### 1. ä¼˜åŒ–ä¸€ï¼šå¹¿å‘Šæ’ä»¶åå±è”½

Umami çš„é»˜è®¤è·Ÿè¸ªä»£ç æ˜¯è¢«å¤§å¤šæ•°çš„å¹¿å‘Šæ’ä»¶å±è”½çš„ï¼Œè¢«å±è”½äº†ä½ å°±ç»Ÿè®¡ä¸åˆ°è®¿å®¢ä¿¡æ¯äº†ã€‚å¦‚æœéœ€è¦åå±è”½ï¼Œéœ€è¦åœ¨ `docker-compose.yml` æ–‡ä»¶ä¸­æ·»åŠ ç¯å¢ƒå˜é‡ï¼š`TRACKER_SCRIPT_NAME`ï¼Œå¦‚ï¼š

```yml
    environment:
      TRACKER_SCRIPT_NAME: random-string.js
```

ç„¶åè·å–åˆ°çš„è·Ÿè¸ªä»£ç çš„ `src` ä¼šå˜æˆï¼š

~~`srcipt.js`~~ => `random-string.js`

```diff
- https://tongji.notumami.com/script.js
+ https://tongji.notumami.com/random-string.js
```

å®˜æ–¹æ–‡æ¡£æä¾›äº†æ›´å¤šçš„ç¯å¢ƒå˜é‡é…ç½®ï¼š<https://umami.is/docs/environment-variables>

#### 2. ä¼˜åŒ–äºŒï¼šè·Ÿè¸ªä»£ç éƒ¨ç½²åˆ°è‡ªå·±çš„ CDN

å¦‚æœè‡ªå·±çš„ VPS æ˜¯å°æ°´ç®¡ï¼Œä¼šå› ä¸ºè·Ÿè¸ªä»£ç çš„å»¶è¿ŸåŠ è½½å½±å“åˆ°ç½‘ç«™çš„åŠ è½½é€Ÿåº¦ï¼Œä¸ºäº†æ›´å¥½çš„ç”¨æˆ·ä½“éªŒå¯ä»¥æŠŠè·Ÿè¸ªä»£ç `random-string.js`ä¸‹è½½ä¸‹æ¥ï¼Œæ”¾åˆ°è‡ªå·±æˆ–è€…æœ‹å‹çš„ CDN ä¸Šã€‚æ¯”å¦‚æ”¾åˆ°è…¾è®¯äº‘çš„ COS é‡Œã€‚
æ­¤æ—¶ `src` å°±å˜æˆäº†ï¼š`https://cdn.notumami.com/random-string.js`ï¼Œåªæ”¾äº†è·Ÿè¸ªä»£ç çš„é“¾æ¥è¿˜æ²¡æœ‰æˆåŠŸï¼Œè¿˜éœ€è¦é…ç½®æ”¶é›†æ•°æ®çš„æœåŠ¡å™¨ã€‚
æ‰€ä»¥éœ€è¦æ·»åŠ  `data_host_url` ï¼Œå®ƒçš„å€¼ä¸º Umami å®é™…çš„ç½‘å€ `https://tongji.notumami.com`ï¼Œå®Œæ•´é…ç½®å¦‚ä¸‹ï¼š

```html
<script
    async
    defer
    data-website-id="cbd4a55a-81e8-42ed-5d04-a0e2315433f0"
    src="https://cdn.notumami.com/random-string.js"
    data-host-url="https://tongji.notumami.com"
    data-domains="eallion.com">
</script>
```

`data-domains` çš„æ„æ€æ˜¯åªåœ¨ç‰¹å®šçš„ç½‘ç«™ä¸Šè¿è¡Œè·Ÿè¸ªä»£ç ã€‚æ¯”å¦‚åœ¨æœ¬åœ°ç”¨ `hugo server` æµ‹è¯• Hugo åšå®¢æ—¶å°±ä¸ä¼šç»Ÿè®¡ `127.0.0.1:1313` çš„è®¿é—®äº†ã€‚
å®˜æ–¹æ–‡æ¡£ä¸­æœ‰æ›´å¤šçš„å¯é…ç½®å‚æ•°ï¼š<https://umami.is/docs/tracker-configuration>

#### 3. ä¼˜åŒ–ä¸‰ï¼šå¦‚ä½•é›†æˆåˆ° API

æœ‰äººé—®åˆ°å¦‚ä½•æŠŠ Umami é›†æˆåˆ° API é‡Œã€‚å¦‚ï¼š

- <https://api.eallion.com/umami/69d6ffe.js?v=2.0.1>

è¿™å…¶å®ä¸ç®—ä¼˜åŒ–ï¼Œåªæ˜¯æˆ‘ä¸ªäººçš„æ´ç™–ï¼Œç½‘ç»œè¯·æ±‚é‡Œä¼šå‡å°‘ä¸€ä¸ª Domain hostã€‚ä¹Ÿé—´æ¥è¾¾åˆ°äº†éšè—çœŸå® Umami åŸŸåçš„æ•ˆæœã€‚
ç®€å•è¯´ä¸‹æ€è·¯ã€‚æˆ‘çš„ API æš‚æ—¶ç”¨çš„æ˜¯è…¾è®¯äº‘çš„å…¨ç«™åŠ é€Ÿï¼ˆå…¶ä»–äº‘æœåŠ¡å•†çš„éƒ½å¯ä»¥ï¼‰ã€‚é…ç½®å…¨ç«™åŠ é€Ÿ CDN çš„æºç«™é‡Œï¼Œç”¨äºŒçº§ç›®å½• `/umami` åä»£ Umami çš„ `3000` ç«¯å£ã€‚

CDN æºç«™çš„ Nginx åä»£é…ç½®ï¼š

```nginx
location ^~ /umami
{
    # ......

    proxy_pass http://127.0.0.1:3000/;

    # ......
}
```

è€Œ `69d6ffe.js` æ˜¯ç”¨ API åŸŸåçš„ `/umami/69d6ffe.js` åšäº† 301 é‡å®šå‘è½¬å‘ã€‚

CDN æºç«™çš„ Nginx é‡å®šå‘é…ç½®ï¼š

```nginx
rewrite ^/umami/69d6ffe.js(.*) https://a.eallion.com/69d6ffe.js permanent;
```

### å…¶ä»–

å¦‚æœåˆ‡æ¢åˆ°ä¸­æ–‡ï¼Œå‘ç°æ— æ³•åˆ é™¤ç½‘ç«™ã€‚éœ€è¦è¾“å…¥ `DELETE`ã€‚

![](/assets/images/posts/2023/04/umami_delete_site.png)
