{{ define "main" }}
{{ .Scratch.Set "scope" "single" }}

{{ $justifiedGalleryCss := resources.Get "css/justifiedGallery.min.css" | fingerprint "sha256" }}
<link rel="stylesheet" href="{{ $justifiedGalleryCss.RelPermalink }}" integrity="{{ $justifiedGalleryCss.Data.Integrity }}" crossorigin="anonymous">

{{ $justifiedGalleryJS := resources.Get "js/jquery.justifiedGallery.min.js" | fingerprint "sha256" }}
<script type="text/javascript" src="{{ $justifiedGalleryJS.RelPermalink }}" integrity="{{ $justifiedGalleryJS.Data.Integrity }}"></script>

{{ $fastBlurhashJS := resources.Get "js/fast-blurhash.min.js" | fingerprint "sha256" }}

{{ $lazyloadJS := resources.Get "js/lazyload.iife.min.js" | fingerprint "sha256" }}
<script type="text/javascript" src="{{ $lazyloadJS.RelPermalink }}" integrity="{{ $lazyloadJS.Data.Integrity }}"></script>

{{ $viewJS := resources.Get "js/view-image.min.js" | fingerprint "sha256" }}
<script type="text/javascript" src="{{ $viewJS.RelPermalink }}" integrity="{{ $viewJS.Data.Integrity }}"></script>

<article>
  {{ if .Params.showHero | default (.Site.Params.article.showHero | default false) }}
  {{ $heroStyle := .Params.heroStyle }}
  {{ if not $heroStyle }}{{ $heroStyle = .Site.Params.article.heroStyle }}{{ end }}
  {{ $heroStyle := print "hero/" $heroStyle ".html" }}
  {{ if templates.Exists ( printf "partials/%s" $heroStyle ) }}
  {{ partial $heroStyle . }}
  {{ else }}
  {{ partial "hero/basic.html" . }}
  {{ end }}
  {{ end }}

  <header id="single_header" class="mt-5 max-w-prose">
    {{ if .Params.showBreadcrumbs | default (.Site.Params.article.showBreadcrumbs | default false) }}
    {{ partial "breadcrumbs.html" . }}
    {{ end }}
    <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
      {{ .Title }}
    </h1>
    <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      {{ partial "article-meta/basic.html" (dict "context" . "scope" "single") }}
    </div>
  </header>

  <noscript>
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
      <strong class="font-bold">Error!</strong>
      <span class="block sm:inline">Please enable JavaScript to view the Album page for layout and lazy loading.</span>
    </div>
  </noscript>

  <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
    <div class="min-w-0 min-h-0 max-w-full">
      <div class="article-content max-w-full mb-20">
        {{ .Content }}

        {{ $albumData := resources.Get "data/album/album.json" | unmarshal }}
        {{ if $albumData }}

        {{ $sortedAlbum := sort $albumData "created_at" "desc" }}
          <div id="ealbum" class="justified-gallery">
            {{ range $sortedAlbum }}
              {{ $statusId := .id }}
              {{ range .media_attachments }}
                {{ $content := .description | plainify | safeHTML }}

                {{ $description := .description | markdownify }}
                {{ $description = replace $description "<br>" "" }}
                {{ $description = replace $description "<br/>" "" }}
                {{ $description = replace $description "<br />" "" }}
                {{ $description = replace $description "\n" "" }}
                {{ $description = replace $description "\r" "" }}
                {{ $description = replace $description "ealbum" "" }}
                {{ $description = $description | chomp }}
                {{ $description = $description | safeHTML }}

                {{ $url := replace .url "https://files.e5n.cc/" "https://mstd-s3-files.eallion.com/" }}
                {{ $preview_url := replace .preview_url "https://files.e5n.cc/" "https://mstd-s3-files.eallion.com/" }}
              <div>
                <a href="{{- $url -}}!albumoriginal.avif" data-blurhash="{{- .blurhash -}}">
                  <img class="lazy"
                      src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                      data-src="{{- $preview_url -}}!album.avif"
                      alt="{{- $description | default $content | markdownify -}}"
                      width="{{- .meta.small.width | default .width -}}"
                      height="{{- .meta.small.height | default .height -}}"
                      />
                </a>
                <div class="jg-caption">
                  <a href="https://e5n.cc/@eallion/{{- $statusId | plainify -}}" class="text-neutral hover:text-neutral" target="_blank" rel="noopener noreferrer" no-view>{{ $description | default $content }}</a>
                  </div>
              </div>
              {{ end }}
            {{ end }}
          </div>
        {{ end }}
      </div>
    </div>
  </section>

<script type="module">

  import { decodeBlurHash } from '{{- $fastBlurhashJS.RelPermalink -}}';

  $(document).ready(function () {
    $("#ealbum").justifiedGallery({
      rowHeight: 220,
      maxRowHeight: -1,
      margins: 12,
      lastRow: 'nojustify',
      selector: 'a, div:not(.jg-caption) a',
      captions: true,
      cssAnimation: true,
      imagesAnimationDuration: 300,
      waitThumbnailsLoad: false
    }).on('jg.complete', function () {
      // Initialize LazyLoad with callbacks to handle blurhash background
      var lazyLoadInstance = new LazyLoad({
        elements_selector: ".lazy",
        callback_enter: function(element) {
          // Get the parent <a> tag
          const parentLink = $(element).closest('a');
          const blurhash = parentLink.data('blurhash');

          if (blurhash) {
            try {
              // Decode blurhash to create a placeholder image
              const pixels = decodeBlurHash(blurhash, 16, 16);

              const canvas = document.createElement('canvas');
              canvas.width = 16;
              canvas.height = 16;
              const ctx = canvas.getContext('2d');
              const imageData = ctx.createImageData(16, 16);
              imageData.data.set(pixels);
              ctx.putImageData(imageData, 0, 0);

              // Set the blurhash image as background
              parentLink.css({
                'background-image': `url(${canvas.toDataURL()})`,
                'background-size': 'cover'
              });
            } catch (e) {
              console.error('Failed to decode blurhash:', e);
            }
          }
        },
        callback_loaded: function(element) {
          // Remove the background once the image has fully loaded
          const parentLink = $(element).closest('a');
          parentLink.css('background-image', 'none');
        },
        callback_error: function(element) {
          // Also remove the background if there's an error loading the image
          const parentLink = $(element).closest('a');
          parentLink.css('background-image', 'none');
        }
      });

      window.ViewImage && ViewImage.init('.justified-gallery a');
    });
  });
</script>

</article>

{{ end }}
