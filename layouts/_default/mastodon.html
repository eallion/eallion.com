{{ define "main" }}
<link rel="preconnect" href="https://e5n.cc">
<link rel="dns-prefetch" href="https://e5n.cc">
<link rel="preconnect" href="https://mstd-s3-files.eallion.com">
<link rel="dns-prefetch" href="https://mstd-s3-files.eallion.com">
<style>
  .mt-content a {
    color: #6364ff;
    text-decoration: underline;
    transition: color 0.1s ease, text-decoration 0.1s ease;
  }

  .mt-container a:hover,
  .mt-container a:focus {
    color: #563acc;
  }

  .mt-container a:focus {
    outline: 2px solid #44648b;
    outline-offset: 2px;
  }

  .invisible {
    font-size: 0;
    line-height: 0;
    display: inline-block;
    width: 0;
    height: 0;
    position: absolute;
  }

  .ellipsis:after {
    content: "â€¦";
  }

  /* view image */
  .view-image-tools {
    opacity: 1;
    animation: 1s 1.5s forwards fadeOut
  }

  .view-image-tools:hover {
    opacity: 1;
    animation: none;
    transition: opacity .2s
  }

  @keyframes fadeOut {
    to {
      opacity: 0
    }
  }

  /* New style for update button (Tailwind classes for basic styling) */
  .mt-update-alert {
    position: sticky;
    top: 0;
    /* è´´åœ¨é¡¶éƒ¨ */
    z-index: 50;
    animation: fadeInDown 0.5s;
  }

  @keyframes fadeInDown {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-spin-slow {
    animation: spin 3s linear infinite;
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }

    to {
      transform: rotate(360deg);
    }
  }

  /* --- æ–°å¢/ä¼˜åŒ–ï¼šChroma OneDark Style for .mt-content --- */

  /* 1. ä»£ç å— <pre> æ ·å¼ (æ·±è‰²èƒŒæ™¯å®¹å™¨) */
  .mt-content pre {
    /* One Dark ä¸»èƒŒæ™¯ */
    background-color: #282C34 !important;
    color: #ABB2BF !important;
    /* é»˜è®¤ä»£ç æ–‡æœ¬é¢œè‰² */
    /* åŸºç¡€æ ·å¼ */
    border-radius: 0.5rem !important;
    padding: 1rem !important;
    overflow-x: auto !important;
    border: none !important;
    font-size: 0.875rem;
    margin: 1rem 0 !important;
  }

  /* 2. è¡Œå†…ä»£ç  <code> æ ·å¼ (ç‹¬ç«‹ã€ç•¥æµ…çš„èƒŒæ™¯) */
  /* æ­¤è§„åˆ™ä½œç”¨äºæ‰€æœ‰ codeï¼Œä½†ä¼šè¢« pre code é‡ç½® */
  .mt-content code {
    /* One Dark è¡Œå†…ä»£ç èƒŒæ™¯ï¼Œç•¥æµ…äº pre */
    background-color: #3e4452 !important;
    color: #ABB2BF !important;
    /* åŸºç¡€æ ·å¼ */
    padding: 0.2em 0.4em !important;
    border-radius: 0.375rem !important;
    white-space: nowrap;
    font-size: 0.875em !important;
    font-weight: 500;
  }

  /* 3. é‡ç½®ä»£ç å—å†…çš„ <code> æ ·å¼ï¼Œä»¥ç¡®ä¿å®ƒç»§æ‰¿ <pre> çš„å¤§èƒŒæ™¯ */
  .mt-content pre code {
    background-color: transparent !important;
    /* ç§»é™¤è¡Œå†…ä»£ç èƒŒæ™¯ */
    padding: 0 !important;
    /* ç§»é™¤è¡Œå†…ä»£ç å¡«å…… */
    color: inherit !important;
    /* ç»§æ‰¿ <pre> çš„æ–‡æœ¬é¢œè‰² */
    font-size: 1em !important;
    /* ä¿æŒä¸ <pre> å®¹å™¨ç›¸åŒçš„å¤§å° */
    border-radius: 0 !important;
    display: block;
    /* ç¡®ä¿ä»£ç å—å†…å®¹æ­£ç¡®æ’ç‰ˆ */
  }
</style>

{{- partial "content/breadcrumb.html" . -}}

<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-14" data-pagefind-ignore="all">

  <article class="md:col-span-2 not-prose">

    <header>

      <h1 id="title" class="text-4xl font-bold leading-normal">{{ .Title }}</h1>

    </header>

    <section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert">

      <div class="min-w-0 min-h-0 max-w-fit">

        <div id="content" class="prose lg:prose-lg dark:prose-invert w-full">

          {{ .Content }}

          <div class="flex w-full mt-10 flex-wrap justify-center gap-5">
            <div class="mt-container w-full max-w-full p-0">
              <div id="mt-loading-spinner" class="mt-conatiner-spinner not-prose flex flex-col items-center">
                <span class="font-semibold">Loading...</span>
                <img src="/assets/images/mastodon/loading.gif" alt="loading">
              </div>
              <div id="mt-update-button-placeholder" class="mt-update-alert mb-8 hidden">
              </div>
              <div id="mt-posts-wrapper" class="mt-posts-wrapper">
              </div>
            </div>
            <div
              class="w-fit mx-auto my-8 border dark:border-[#444c56] rounded-full px-6 py-2 hover:bg-zinc-200 dark:hover:bg-[#252a33] cursor-pointer">
              <a href="https://e5n.cc/@eallion" target="_blank" rel="noopener noreferrer"
                class="flex items-center justify-center not-prose gap-1">
                <div>ç‚¹å‡» e5n.cc æŸ¥çœ‹æ›´å¤š</div>
                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" class="inline-block" aria-hidden="true"
                  fill="currentColor" viewBox="0 0 14 10">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M1 5h12m0 0L9 1m4 4L9 9"></path>
                </svg>
              </a>
            </div>
          </div>
        </div>

      </div>

    </section>

  </article>

  <aside class="md:col-span-1">

    <div class="lg:sticky lg:top-8 mb-13">

      <div
        class="rounded-2xl p-8 text-zinc-700 dark:text-[#adbac7] bg-zinc-100 dark:bg-[#2d333b] mb-10 flex flex-col items-center justify-center gap-0">

        <div class="shrink-0">
          <img class="h-20 w-20 rounded-full object-cover ring-4 ring-gray-200 dark:ring-[#cdd9e51a] shadow-lg"
            width="144" height="144" alt="Charles Chin" src="/eallion.webp">
        </div>

        <div class="flex items-center justify-center mt-4 text-2xl text-zinc-950 dark:text-[#adbac7] hover:cursor-text">
          <div class="font-semibold">Charles Chin</div>
          <div class="flex items-center ml-1"><svg viewBox="0 0 22 22" fill="#1d9bf0" aria-label="è®¤è¯è´¦å·" role="img"
              class="inline-block" width="1em" height="1em" data-testid="icon-verified">
              <g>
                <path
                  d="M20.396 11c-.018-.646-.215-1.275-.57-1.816-.354-.54-.852-.972-1.438-1.246.223-.607.27-1.264.14-1.897-.131-.634-.437-1.218-.882-1.687-.47-.445-1.053-.75-1.687-.882-.633-.13-1.29-.083-1.897.14-.273-.587-.704-1.086-1.245-1.44S11.647 1.62 11 1.604c-.646.017-1.273.213-1.813.568s-.969.854-1.24 1.44c-.608-.223-1.267-.272-1.902-.14-.635.13-1.22.436-1.69.882-.445.47-.749 1.055-.878 1.688-.13.633-.08 1.29.144 1.896-.587.274-1.087.705-1.443 1.245-.356.54-.555 1.17-.574 1.817.02.647.218 1.276.574 1.817.356.54.856.972 1.443 1.245-.224.606-.274 1.263-.144 1.896.13.634.433 1.218.877 1.688.47.443 1.054.747 1.687.878.633.132 1.29.084 1.897-.136.274.586.705 1.084 1.246 1.439.54.354 1.17.551 1.816.569.647-.016 1.276-.213 1.817-.567s.972-.854 1.245-1.44c.604.239 1.266.296 1.903.164.636-.132 1.22-.447 1.68-.907.46-.46.776-1.044.908-1.681s.075-1.299-.165-1.903c.586-.274 1.084-.705 1.439-1.246.354-.54.551-1.17.569-1.816zM9.662 14.85l-3.429-3.428 1.293-1.302 2.072 2.072 4.4-4.794 1.347 1.246z">
                </path>
              </g>
            </svg></div>
        </div>

        <div class="group relative text-xl text-center px-0 mb-4">
          <a href="https://e5n.cc/@eallion" target="_blank" rel="noopener noreferrer" aria-label="mastodon"
            class="hover:underline">@eallion@e5n.cc</a>
        </div>

        <div class="w-full px-0 pt-2 border-t border-zinc-200 dark:border-[#cdd9e51a]">

          <div class="p-4">
            <div class="flex flex-col justify-between">
              <p class="text-xl">ğŸ‘‹ Welcome!</p>
              <ul class="mt-6 mb-2 ml-4 flex flex-col prose dark:prose-invert">
                <li class="before:content-['â€¢'] before:mr-2 before:opacity-50 my-2">It's a single mode Mastodon.</li>
                <li class="before:content-['â€¢'] before:mr-2 before:opacity-50 my-2">Registrations closed.</li>
                <li class="before:content-['â€¢'] before:mr-2 before:opacity-50 my-2">Private but public readable.</li>
                <li class="before:content-['â€¢'] before:mr-2 before:opacity-50 my-2"><ruby>ä¸­æ–‡<rt>Chinese</rt></ruby>
                  content.</li>
                <li class="before:content-['â€¢'] before:mr-2 before:opacity-50 my-2">With a little English mixed in.</li>
                <li class="before:content-['â€¢'] before:mr-2 before:opacity-50 my-2">Talk to myself.</li>
                <li class="before:content-['â€¢'] before:mr-2 before:opacity-50 my-2">talk about myself.</li>
              </ul>
            </div>
          </div>

        </div>

        <div class="w-full grid grid-cols-3 gap-4 px-6 pt-4 border-t border-zinc-200 dark:border-[#cdd9e51a]">
          <div class="flex flex-col items-center">
            <div class="text-zinc-500 dark:text-[#768390]">å…³æ³¨è€…</div>
            <div class="font-semibold flex items-center">
              <span id="followers">-1</span>
            </div>
          </div>
          <div class="flex flex-col items-center">
            <div class="text-zinc-500 dark:text-[#768390]">æ­£åœ¨å…³æ³¨</div>
            <div class="font-semibold flex items-center">
              <span id="following">0</span>
            </div>
          </div>
          <div class="flex flex-col items-center">
            <div class="text-zinc-500 dark:text-[#768390]">å˜Ÿæ–‡</div>
            <div class="font-semibold flex items-center">
              <span id="statuses">0</span>
            </div>
          </div>
        </div>

      </div>

    </div>
  </aside>

</div>

{{ partial "content/newsletter.html" . }}

<script>
  // --- Constants and Global Variables ---
  const API_URL = 'https://e5n.cc/api/v1/accounts/111136231674527355/statuses?limit=13&exclude_replies=true&exclude_reblogs=true&only_media=true';
  const CACHE_KEY = 'mastodon_cache';
  const PENDING_KEY = 'mastodon_pending_update';
  const CACHE_LIFETIME = 7 * 24 * 60 * 60 * 1000; // 7 å¤© (é¦–æ¬¡ç¼“å­˜æœ‰æ•ˆæœŸ)
  const UPDATE_INTERVAL = 60 * 1000; // 1 åˆ†é’Ÿ (å‰å°æ¿€æ´»æ—¶æ£€æŸ¥é¢‘ç‡)

  let updateTimer = null; // å®šæ—¶å™¨å¥æŸ„

  // --- Helper Functions ( extracted from original inline code) ---

  const replaceFileUrl = url => url.replace('https://files.e5n.cc/', 'https://mstd-s3-files.eallion.com/');

  const getImageObjectFitClass = (imgWidth, aspectRatio, isSingleImage = false) => {
    if (isSingleImage) {
      return (imgWidth > 640 && (aspectRatio >= 1.33 && aspectRatio <= 1.78))
        ? 'object-cover'
        : 'object-contain';
    } else {
      return (imgWidth < 320 || aspectRatio < 0.56 || aspectRatio > 2.3)
        ? 'object-contain'
        : 'object-cover';
    }
  };

  function encodeExternalLinks(content) {
    const allowedDomains = ['e5n.cc', 'eallion.com', 'www.eallion.com'];
    const linkRegex = /<a[^>]*href\s*=\s*["']([^"']*)["'][^>]*>/gi;

    return content.replace(linkRegex, (match, url) => {
      try {
        let hostname;
        let pathname;
        try {
          const urlObj = new URL(url);
          hostname = urlObj.hostname;
          pathname = urlObj.pathname;
        } catch (urlError) {
          return match;
        }

        if (hostname === 'e5n.cc' || hostname === 's.e5n.cc') {
          if (!match.includes('target="_blank"')) {
            return match.replace(/>/, ' target="_blank">');
          }
          return match;
        }

        const isAllowedDomain = allowedDomains.some(domain =>
          hostname === domain || hostname.endsWith('.' + domain)
        );

        if (isAllowedDomain) {
          return match;
        }

        const encodedUrl = btoa(url);
        const redirectUrl = `https://www.eallion.com/go/?target=${encodedUrl}`;

        return match.replace(url, redirectUrl);
      } catch (e) {
        return match;
      }
    });
  }

  function getRelativeTime(dateString) {
    const rtf = new Intl.RelativeTimeFormat('zh-CN', { numeric: "auto", style: 'short' });
    const now = new Date();
    const date = new Date(dateString);
    const diff = now - date;

    const seconds = Math.floor(diff / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    const months = Math.floor(days / 30);
    const years = Math.floor(days / 365);

    let formattedTime;
    if (years > 0) {
      formattedTime = rtf.format(-years, 'year');
    } else if (months > 0) {
      formattedTime = rtf.format(-months, 'month');
    } else if (days > 0) {
      formattedTime = rtf.format(-days, 'day');
    } else if (hours > 0) {
      formattedTime = rtf.format(-hours, 'hour');
    } else if (minutes > 0) {
      formattedTime = rtf.format(-minutes, 'minute');
    } else {
      formattedTime = rtf.format(-seconds, 'second');
    }

    return formattedTime.replace(/(\d+)([^\d]+)/, '$1 $2');
  }

  function updateRelativeTimes() {
    const timeElements = document.querySelectorAll('[data-created-at]');
    timeElements.forEach(element => {
      const dateString = element.getAttribute('data-created-at');
      if (dateString) {
        const timeText = getRelativeTime(dateString);
        const link = element.querySelector('a');
        if (link) {
          link.textContent = timeText;
        } else {
          element.textContent = timeText;
        }
      }
    });

    // ä¿æŒæ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡ç›¸å¯¹æ—¶é—´çš„é€»è¾‘
    setTimeout(updateRelativeTimes, 60000);
  }

  // --- Rendering Functions ---

  /**
   * æ¸²æŸ“å¸–å­å†…å®¹å’Œè®¡æ•°
   * @param {Array} data - Mastodon å˜Ÿæ–‡æ•°æ®
   */
  function renderContent(data) {
    const postsWrapper = document.getElementById('mt-posts-wrapper');
    const followers = document.getElementById('followers');
    const following = document.getElementById('following');
    const statuses = document.getElementById('statuses');

    // æ¸…ç©ºç°æœ‰å†…å®¹
    postsWrapper.innerHTML = '';

    // æ›´æ–°ä¾§è¾¹æ è®¡æ•°
    if (data.length > 0) {
      followers.textContent = data[0].account.followers_count;
      following.textContent = data[0].account.following_count;
      statuses.textContent = data[0].account.statuses_count;
    } else {
      // API è¿”å›ç©ºæ•°ç»„ï¼Œå¯èƒ½æ˜¯æ²¡æœ‰å˜Ÿæ–‡
      followers.textContent = '-1';
      following.textContent = '0';
      statuses.textContent = '0';
    }

    data.forEach(post => {
      const article = document.createElement('article');
      article.className = 'bg-white dark:bg-[#2d333b] border dark:border-[#cdd9e51a] rounded-2xl mb-8 last:mb-0 p-6 pb-4 shadow-sm hover:shadow-md transition-shadow duration-300';

      // åˆ¤æ–­æ˜¯å¦ä¸ºè½¬å‘
      if (post.reblog) {
        article.innerHTML += `
          <div class="mt-reblog flex items-center gap-2 mb-2 text-zinc-500 text-sm">
            <span class="text-green-500 dark:text-[#768390]">ğŸ”„</span>
            <span>Charles Chin è½¬å‘äº†</span>
          </div>
        `;
      }

      // å¤´åƒéƒ¨åˆ†
      article.innerHTML += `
        <div class="flex items-center flex-row gap-2">
          <div class="mt-reblog-avatar w-12 h-12 mr-3 flex-shrink-0 relative">
            <img src="${post.reblog ? replaceFileUrl(post.reblog.account.avatar) : '/eallion.webp'}" alt="å¤´åƒ" class="w-full h-full object-cover rounded-lg no-view nozoom outline-1 outline-zinc-400 dark:outline-[#cdd9e51a]" no-view onerror="this.src='/assets/images/mastodon/missing.png'">
            ${post.reblog ? '<div class="mt-reblog-avatar-overlay absolute -bottom-1 -right-1 w-2/3 h-2/3 no-view"><img src="/favicon-32x32.png" alt="Boost" class="w-full h-full mt-0 mb-0 object-cover nozoom" no-view></div>' : ''}
          </div>
          <div class="flex-1 flex flex-row items-start min-w-0">
            <div class="flex flex-col flex-wrap items-start gap-0 mb-1">
              <span class="mt-accout-name font-semibold hover:font-extrabold text-zinc-700-700 hover:text-zinc-900">${post.reblog ? post.reblog.account.display_name : 'Charles Chin'}</span>
              <a href="https://e5n.cc/@eallion" target="_blank" rel="noopener noreferrer" class="mt-accout-id text-base decoration-auto no-underline hover:underline">${post.reblog ? post.reblog.account.acct : '@eallion@e5n.cc'}</a>
            </div>
            <div class="inline md:hidden px-2 py-1.5 text-zinc-700 hover:text-zinc-900 text-sm ml-auto">
              <span class="mt-footer-date" data-created-at="${post.created_at}">
                <a href="${post.url || 'https://e5n.cc/@eallion'}" target="_blank" rel="noopener noreferrer" class="no-underline text-zinc-600 hover:text-zinc-900-700">-</a>
              </span>
            </div>
            <div class="hidden md:flex flex-row items-center gap-1.5 ml-auto px-2 text-sm ">
              <span class="mt-meta-language">
                ${post.language ?
          (post.language.toLowerCase() === 'zh' || post.language.toLowerCase() === 'zh-cn' ? 'zh-CN' : post.language)
          : ''}
              </span>
              ${post.content.includes('http') ? '<span class="mt-meta-link"><svg xmlns="http://www.w3.org/2000/svg" width="1rem" height="1rem" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="48" stroke-dashoffset="48" d="M11 5h-6v14h14v-6"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.6s" values="48;0"/></path><path stroke-dasharray="12" stroke-dashoffset="12" d="M13 11l7 -7"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="12;0"/></path><path stroke-dasharray="8" stroke-dashoffset="8" d="M21 3h-6M21 3v6"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.8s" dur="0.2s" values="8;0"/></path></g></svg></span>' : ''}
              ${post.media_attachments.length > 0 ? '<span class="mt-meta-image"><svg xmlns="http://www.w3.org/2000/svg" width="1rem" height="1rem" viewBox="0 0 48 48"><g fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="4"><path stroke-linecap="round" d="M5 10C5 8.89543 5.89543 8 7 8L41 8C42.1046 8 43 8.89543 43 10V38C43 39.1046 42.1046 40 41 40H7C5.89543 40 5 39.1046 5 38V10Z" clip-rule="evenodd"/><path stroke-linecap="round" d="M14.5 18C15.3284 18 16 17.3284 16 16.5C16 15.6716 15.3284 15 14.5 15C13.6716 15 13 15.6716 13 16.5C13 17.3284 13.6716 18 14.5 18Z" clip-rule="evenodd"/><path fill="#2f88ff" d="M15 24L20 28L26 21L43 34V38C43 39.1046 42.1046 40 41 40H7C5.89543 40 5 39.1046 5 38V34L15 24Z"/></g></svg></span>' : ''}
              ${post.in_reply_to_id ? '<span class="mt-meta-reply"><svg xmlns="http://www.w3.org/2000/svg" width="1rem" height="1rem" viewBox="0 0 24 24"><path fill="currentColor" d="M12 23a1 1 0 0 1-1-1v-3H7a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-4.1l-3.7 3.71c-.2.18-.44.29-.7.29zm-9-8H1V3a2 2 0 0 1 2-2h16v2H3z"/></svg></span>' : ''}
              ${post.reblog ? '<span class="mt-meta-reblog"><svg xmlns="http://www.w3.org/2000/svg" width="1.13rem" height="1rem" viewBox="0 0 576 512"><path fill="currentColor" d="M272 416c17.7 0 32-14.3 32-32s-14.3-32-32-32H160c-17.7 0-32-14.3-32-32V192h32c12.9 0 24.6-7.8 29.6-19.8s2.2-25.7-6.9-34.9l-64-64c-12.5-12.5-32.8-12.5-45.3 0l-64 64c-9.2 9.2-11.9 22.9-6.9 34.9S19.1 192 32.1 192h32v128c0 53 43 96 96 96h112zm32-320c-17.7 0-32 14.3-32 32s14.3 32 32 32h112c17.7 0 32 14.3 32 32v128h-32c-12.9 0-24.6 7.8-29.6 19.8s-2.2 25.7 6.9 34.9l64 64c12.5 12.5 32.8 12.5 45.3 0l64-64c9.2-9.2 11.9-22.9 6.9-34.9S556.9 320 543.9 320h-32V192c0-53-43-96-96-96z"/></svg></span>' : ''}
              <span class="mt-meta-visibility">
                ${post.visibility === 'direct' ? '<svg xmlns="http://www.w3.org/2000/svg" height="1.1rem" viewBox="0 -960 960 960" width="1.1rem" class="icon icon-envelope status__visibility-icon" title="ç§ä¸‹æåŠ" aria-label="ç§ä¸‹æåŠ" role="img"><path fill="#d32f2f" d="M160-160q-33 0-56.5-23.5T80-240v-480q0-33 23.5-56.5T160-800h640q33 0 56.5 23.5T880-720v480q0 33-23.5 56.5T800-160H160Zm320-280L160-640v400h640v-400L480-440Zm0-80 320-200H160l320 200ZM160-640v-80 480-400Z"></path></svg>' :
          post.visibility === 'unlisted' ? '<svg xmlns="http://www.w3.org/2000/svg" height="1.1rem" viewBox="0 -960 960 960" width="1.1rem" class="icon icon-unlock status__visibility-icon" title="æ‚„æ‚„å…¬å¼€" aria-label="æ‚„æ‚„å…¬å¼€" role="img"><path fill="#388e3c" d="M484-80q-84 0-157.5-32t-128-86.5Q144-253 112-326.5T80-484q0-146 93-257.5T410-880q-18 99 11 193.5T521-521q71 71 165.5 100T880-410q-26 144-138 237T484-80Zm0-80q88 0 163-44t118-121q-86-8-163-43.5T464-465q-61-61-97-138t-43-163q-77 43-120.5 118.5T160-484q0 135 94.5 229.5T484-160Zm-20-305Z"></path></svg>' :
            post.visibility === 'private' ? '<svg xmlns="http://www.w3.org/2000/svg" height="1.1rem" viewBox="0 -960 960 960" width="1.1rem" class="icon icon-lock status__visibility-icon" title="å…³æ³¨è€…" aria-label="å…³æ³¨è€…" role="img"><path fill="#ffa000" d="M240-80q-33 0-56.5-23.5T160-160v-400q0-33 23.5-56.5T240-640h40v-80q0-83 58.5-141.5T480-920q83 0 141.5 58.5T680-720v80h40q33 0 56.5 23.5T800-560v400q0 33-23.5 56.5T720-80H240Zm0-80h480v-400H240v400Zm240-120q33 0 56.5-23.5T560-360q0-33-23.5-56.5T480-440q-33 0-56.5 23.5T400-360q0 33 23.5 56.5T480-280ZM360-640h240v-80q0-50-35-85t-85-35q-50 0-85 35t-35 85v80ZM240-160v-400 400Z"></path></svg>' :
              '<svg xmlns="http://www.w3.org/2000/svg" height="1.1rem" viewBox="0 -960 960 960" width="1.1rem" class="icon icon-globe status__visibility-icon" title="å…¬å¼€" aria-label="å…¬å¼€" role="img"><path fill="#1976d2" d="M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm-40-82v-78q-33 0-56.5-23.5T360-320v-40L168-552q-3 18-5.5 36t-2.5 36q0 121 79.5 212T440-162Zm276-102q41-45 62.5-100.5T800-480q0-98-54.5-179T600-776v16q0 33-23.5 56.5T520-680h-80v80q0 17-11.5 28.5T400-560h-80v80h240q17 0 28.5 11.5T600-440v120h40q26 0 47 15.5t29 40.5Z"></path></svg>'}
              </span>
            </div>
          </div>
        </div>
      `;

      // å†…å®¹éƒ¨åˆ†
      article.innerHTML += `
        <div class="mt-content my-4 prose dark:prose-invert">
          ${encodeExternalLinks(post.reblog?.content || post.content)}

          ${post.media_attachments.length > 0 ? `
            <div class="mt-images-container mt-4 mb-6 aspect-[16/9] rounded-xl overflow-hidden relative">
              ${(post.sensitive || post.reblog?.sensitive) ? `
                <div class="absolute inset-0 bg-zinc-800 opacity-99 flex flex-col items-center justify-center z-10 rounded-lg cursor-pointer" onclick="this.style.display='none'">
                  <div class="text-white font-bold text-lg mb-2"><svg xmlns="http://www.w3.org/2000/svg" width="8rem" height="8rem" viewBox="0 0 16 16"><path fill="currentColor" d="M1 7a6 6 0 0 1 11.99-.34q.175.194.302.446l.59 1.18Q13.999 7.662 14 7a7 7 0 1 0-7.713 6.964l.484-.968A6 6 0 0 1 1 7m8.854-1.146a.5.5 0 0 0-.708-.708L6.25 8.043L4.854 6.646a.5.5 0 1 0-.708.708l1.75 1.75a.5.5 0 0 0 .708 0zm.749 1.7l-3.496 6.998A1 1 0 0 0 8.002 16h6.996a1 1 0 0 0 .895-1.448l-3.5-6.999a1 1 0 0 0-1.79 0m1.395 1.941v3.002a.5.5 0 1 1-1 0V9.495a.5.5 0 1 1 1 0m-.5 5.504a.5.5 0 1 1 0-1a.5.5 0 0 1 0 1"/></svg></div>
                  <div class="text-zinc-400 text-3xl mt-4 mb-4">NSFW</div>
                  <div class="flex items-center text-zinc-400 text-xl"><span><svg xmlns="http://www.w3.org/2000/svg" width="1.25rem" height="1.25rem" viewBox="0 0 36 36"><path fill="currentColor" d="M30.4 17.6c-1.8-1.9-4.2-3.2-6.7-3.7q-1.65-.45-3.3-.6c2.8-3.3 2.3-8.3-1-11.1s-8.3-2.3-11.1 1s-2.3 8.3 1 11.1c.6.5 1.2.9 1.8 1.1v2.2l-1.6-1.5c-1.4-1.4-3.7-1.4-5.2 0c-1.4 1.4-1.5 3.6-.1 5l4.6 5.4c.2 1.4.7 2.7 1.4 3.9c.5.9 1.2 1.8 1.9 2.5v1.9c0 .6.4 1 1 1h13.6c.5 0 1-.5 1-1v-2.6c1.9-2.3 2.9-5.2 2.9-8.1v-5.8c.1-.4 0-.6-.2-.7m-22-9.4c0-3.3 2.7-5.9 6-5.8c3.3 0 5.9 2.7 5.8 6c0 1.8-.8 3.4-2.2 4.5v-5a3.4 3.4 0 0 0-3.4-3.2c-1.8-.1-3.4 1.4-3.4 3.2v5.2c-1.7-1-2.7-2.9-2.8-4.9M28.7 24c.1 2.6-.8 5.1-2.5 7.1c-.2.2-.4.4-.4.7v2.1H14.2v-1.4c0-.3-.2-.6-.4-.8c-.7-.6-1.3-1.3-1.8-2.2c-.6-1-1-2.2-1.2-3.4c0-.2-.1-.4-.2-.6l-4.8-5.7c-.3-.3-.5-.7-.5-1.2c0-.4.2-.9.5-1.2c.7-.6 1.7-.6 2.4 0l2.9 2.9v3l1.9-1V7.9c.1-.7.7-1.3 1.5-1.2c.7 0 1.4.5 1.4 1.2v11.5l2 .4v-4.6c.1-.1.2-.1.3-.2c.7 0 1.4.1 2.1.2v5.1l1.6.3v-4.6c.9.4 1.7 1 2.4 1.7z" class="clr-i-outline clr-i-outline-path-1"/><path fill="none" d="M0 0h36v36H0z"/></svg></span>ç‚¹å‡»æ˜¾ç¤ºå›¾ç‰‡</div>
                </div>
              ` : ''}

              ${(() => {
            const mediaItems = post.media_attachments;
            let mediaHtml = '';

            if (mediaItems.length === 1) {
              const singleMedia = mediaItems[0];
              const objectFitClass = getImageObjectFitClass(
                singleMedia.meta?.small?.width,
                singleMedia.meta?.small?.aspect,
                true
              );
              mediaHtml = `
                    <div class="flex flex-row h-full">
                      <div class="relative w-full rounded-xl overflow-hidden">
                        ${singleMedia.blurhash ? `<canvas class="absolute inset-0 z-0 w-full h-full top-0 object-cover" data-blurhash="${singleMedia.blurhash}"></canvas>` : ''}
                        <a href="${replaceFileUrl(singleMedia.url)}" class="relative z-10">
                          <picture class="block w-full h-full ${objectFitClass}">
                            <source srcset="${replaceFileUrl(singleMedia.preview_url)}!mastodon.avif" type="image/avif">
                            <img src="${replaceFileUrl(singleMedia.preview_url)}" alt="${singleMedia.description}" class="w-full h-full ${objectFitClass}" nozoom loading="lazy">
                          </picture>
                        </a>
                      </div>
                    </div>
                  `;
            } else if (mediaItems.length === 2) {
              mediaHtml = `
                    <div class="flex flex-row h-full gap-2.5">
                      ${mediaItems.map((mediaItem, index) => {
                const objectFitClass = getImageObjectFitClass(
                  mediaItem.meta?.small?.width,
                  mediaItem.meta?.small?.aspect
                );
                const alignmentClass = index === 0 ? 'left-0' : 'right-0';
                return `
                          <div class="relative w-1/2 rounded-xl overflow-hidden">
                            ${mediaItem.blurhash ? `<canvas class="absolute inset-0 z-0 w-full h-full top-0 object-contain ${alignmentClass}" data-blurhash="${mediaItem.blurhash}"></canvas>` : ''}
                            <a href="${replaceFileUrl(mediaItem.url)}" class="relative z-10">
                              <picture class="block w-full h-full ${objectFitClass}">
                                <source srcset="${replaceFileUrl(mediaItem.preview_url)}!mastodon.avif" type="image/avif">
                                <img src="${replaceFileUrl(mediaItem.preview_url)}" alt="${mediaItem.description}" class="w-full h-full ${objectFitClass}" nozoom loading="lazy">
                              </picture>
                            </a>
                          </div>
                        `;
              }).join('')}
                    </div>
                  `;
            } else if (mediaItems.length === 3) {
              const [firstItem, secondItem, thirdItem] = mediaItems;
              const firstFitClass = getImageObjectFitClass(
                firstItem.meta?.small?.width,
                firstItem.meta?.small?.aspect
              );
              const secondFitClass = getImageObjectFitClass(
                secondItem.meta?.small?.width,
                secondItem.meta?.small?.aspect
              );
              const thirdFitClass = getImageObjectFitClass(
                thirdItem.meta?.small?.width,
                thirdItem.meta?.small?.aspect
              );

              mediaHtml = `
                    <div class="flex h-full gap-2.5">
                      <div class="relative w-1/2 overflow-hidden rounded-xl">
                        ${firstItem.blurhash ? `<canvas class="absolute inset-0 z-0 w-full h-full top-0 left-0 object-contain" data-blurhash="${firstItem.blurhash}"></canvas>` : ''}
                        <a href="${replaceFileUrl(firstItem.url)}" class="relative z-10">
                          <picture class="block w-full h-full ${firstFitClass}">
                            <source srcset="${replaceFileUrl(firstItem.preview_url)}!mastodon.avif" type="image/avif">
                            <img src="${replaceFileUrl(firstItem.preview_url)}" alt="${firstItem.description}" class="w-full h-full ${firstFitClass}" nozoom loading="lazy">
                          </picture>
                        </a>
                      </div>
                      <div class="w-1/2 flex flex-col gap-2.5">
                        <div class="relative h-1/2 overflow-hidden rounded-xl">
                          ${secondItem.blurhash ? `<canvas class="absolute inset-0 z-0 w-full h-full top-0 right-0 object-contain" data-blurhash="${secondItem.blurhash}"></canvas>` : ''}
                          <a href="${replaceFileUrl(secondItem.url)}" class="relative z-10">
                            <picture class="block w-full h-full ${secondFitClass}">
                              <source srcset="${replaceFileUrl(secondItem.preview_url)}!mastodon.avif" type="image/avif">
                              <img src="${replaceFileUrl(secondItem.preview_url)}" alt="${secondItem.description}" class="w-full h-full ${secondFitClass}" nozoom loading="lazy">
                            </picture>
                          </a>
                        </div>
                        <div class="relative h-1/2 overflow-hidden rounded-xl">
                          ${thirdItem.blurhash ? `<canvas class="absolute inset-0 z-0 w-full h-full bottom-0 right-0 object-contain" data-blurhash="${thirdItem.blurhash}"></canvas>` : ''}
                          <a href="${replaceFileUrl(thirdItem.url)}" class="relative z-10">
                            <picture class="block w-full h-full ${thirdFitClass}">
                              <source srcset="${replaceFileUrl(thirdItem.preview_url)}!mastodon.avif" type="image/avif">
                              <img src="${replaceFileUrl(thirdItem.preview_url)}" alt="${thirdItem.description}" class="w-full h-full ${thirdFitClass}" nozoom loading="lazy">
                            </picture>
                          </a>
                        </div>
                      </div>
                    </div>
                  `;
            } else {
              mediaHtml = `
                    <div class="grid grid-cols-2 grid-rows-2 h-full gap-2.5">
                      ${mediaItems.slice(0, 4).map(mediaItem => {
                const objectFitClass = getImageObjectFitClass(
                  mediaItem.meta?.small?.width,
                  mediaItem.meta?.small?.aspect
                );
                return `
                          <div class="relative overflow-hidden rounded-xl">
                            ${mediaItem.blurhash ? `<canvas class="absolute inset-0 z-0 w-full h-full object-contain" data-blurhash="${mediaItem.blurhash}"></canvas>` : ''}
                            <a href="${replaceFileUrl(mediaItem.url)}" class="relative z-10">
                              <picture class="block w-full h-full ${objectFitClass}">
                                <source srcset="${replaceFileUrl(mediaItem.preview_url)}!mastodon.avif" type="image/avif">
                                <img src="${replaceFileUrl(mediaItem.preview_url)}" alt="${mediaItem.description}" class="w-full h-full ${objectFitClass}" nozoom loading="lazy">
                              </picture>
                            </a>
                          </div>
                        `;
              }).join('')}
                    </div>
                  `;
            }

            return mediaHtml;
          })()}
            </div>
          ` : ''}
        </div>
      `;

      // åº•éƒ¨æŒ‰é’®
      article.innerHTML += `
        <div class="flex justify-between md:justify-start items-center gap-4 pt-4 border-t border-zinc-300 dark:border-[#cdd9e51a]">
          <button onclick="window.open('${post.url || "https://e5n.cc/@eallion"}', '_blank')" class="flex items-center gap-1 px-2 py-1.5 text-zinc-700 dark:text-[#768390] hover:text-zinc-900 dark:hover:text-[#adbac7] hover:bg-zinc-300 dark:hover:bg-[#22272e] rounded-md transition-all duration-200 text-sm hover:cursor-pointer">
            <span><svg xmlns="http://www.w3.org/2000/svg" width="1rem" height="1rem" viewBox="0 0 512 512"><path fill="currentColor" d="M204.2 18.4c12 5 19.8 16.6 19.8 29.6v80h112c97.2 0 176 78.8 176 176c0 113.3-81.5 163.9-100.2 174.1c-2.5 1.4-5.3 1.9-8.1 1.9c-10.9 0-19.7-8.9-19.7-19.7c0-7.5 4.3-14.4 9.8-19.5c9.4-8.8 22.2-26.4 22.2-56.7c0-53-43-96-96-96h-96v80c0 12.9-7.8 24.6-19.8 29.6s-25.7 2.2-34.9-6.9l-160-160c-12.5-12.5-12.5-32.8 0-45.3l160-160c9.2-9.2 22.9-11.9 34.9-6.9z" /></svg></span>
            ${post.replies_count ? `<span class="mt-footer-reply">${post.replies_count}</span>` : ''}
          </button>
          <button onclick="window.open('${post.url || "https://e5n.cc/@eallion"}', '_blank')" class="flex items-center gap-1 px-2 py-1.5 text-zinc-700 dark:text-[#768390] hover:text-zinc-900 dark:hover:text-[#adbac7] hover:bg-zinc-300 dark:hover:bg-[#22272e] rounded-md transition-all duration-200 text-sm hover:cursor-pointer">
            <span><svg xmlns="http://www.w3.org/2000/svg" width="1.13rem" height="1rem" viewBox="0 0 576 512"><path fill="currentColor" d="M118.6 41.4c-12.5-12.5-32.8-12.5-45.3 0l-64 64c-9.2 9.2-11.9 22.9-6.9 34.9S19.1 160 32 160h32v224c0 53 43 96 96 96h128c17.7 0 32-14.3 32-32s-14.3-32-32-32H160c-17.7 0-32-14.3-32-32V160h32c12.9 0 24.6-7.8 29.6-19.8s2.2-25.7-6.9-34.9l-64-64zm338.8 429.2c12.5 12.5 32.8 12.5 45.3 0l64-64c9.2-9.2 11.9-22.9 6.9-34.9S556.9 352 544 352h-32V128c0-53-43-96-96-96H288c-17.7 0-32 14.3-32 32s14.3 32 32 32h128c17.7 0 32 14.3 32 32v224h-32c-12.9 0-24.6 7.8-29.6 19.8s-2.2 25.7 6.9 34.9l64 64z" /></svg></span>
            ${post.reblogs_count ? `<span class="mt-footer-reblog">${post.reblogs_count}</span>` : ''}
          </button>
          <button onclick="window.open('${post.url || "https://e5n.cc/@eallion"}', '_blank')" class="flex items-center gap-1 px-2 py-1.5 text-zinc-700 dark:text-[#768390] hover:text-zinc-900 dark:hover:text-[#adbac7] hover:bg-zinc-300 dark:hover:bg-[#22272e] rounded-md transition-all duration-200 text-sm hover:cursor-pointer">
            <span><svg xmlns="http://www.w3.org/2000/svg" width="1.13rem" height="1rem" viewBox="0 0 576 512"><path fill="currentColor" d="M309.5-18.9c-4.1-8-12.4-13.1-21.4-13.1s-17.3 5.1-21.4 13.1l-73.6 144.2l-159.9 25.4c-8.9 1.4-16.3 7.7-19.1 16.3s-.5 18 5.8 24.4l114.4 114.5l-25.2 159.9c-1.4 8.9 2.3 17.9 9.6 23.2s16.9 6.1 25 2l144.4-73.4L432.4 491c8 4.1 17.7 3.3 25-2s11-14.2 9.6-23.2l-25.3-159.9l114.4-114.5c6.4-6.4 8.6-15.8 5.8-24.4s-10.1-14.9-19.1-16.3L383 125.3z" /></svg></span>
            ${post.favourites_count ? `<span class="mt-footer-favourit">${post.favourites_count}</span>` : ''}
          </button>
          <button onclick="window.open('${post.url || "https://e5n.cc/@eallion"}', '_blank')" class="flex items-center gap-1 px-2 py-1.5 text-zinc-700 dark:text-[#768390] hover:text-zinc-900 dark:hover:text-[#adbac7] hover:bg-zinc-300 dark:hover:bg-[#22272e] rounded-md transition-all duration-200 text-sm hover:cursor-pointer">
            <span><svg xmlns="http://www.w3.org/2000/svg" width="0.75rem" height="1rem" viewBox="0 0 384 512"><path fill="currentColor" d="M64 0C28.7 0 0 28.7 0 64v416c0 11.5 6.2 22.2 16.2 27.8s22.3 5.5 32.2-.4L192 421.3l143.5 86.1c9.9 5.9 22.2 6.1 32.2.4S384 491.5 384 480V64c0-35.3-28.7-64-64-64z" /></svg></span>
            ${post.bookmarked ? `<span class="mt-footer-favourit">${post.bookmarked}</span>` : ''}
          </button>
          <button onclick="window.open('${post.url || "https://e5n.cc/@eallion"}', '_blank')" class="flex items-center gap-1 px-2 py-1.5 text-zinc-700 dark:text-[#768390] hover:text-zinc-900 dark:hover:text-[#adbac7] hover:bg-zinc-300 dark:hover:bg-[#22272e] rounded-md transition-all duration-200 text-sm hover:cursor-pointer">
            <span><svg xmlns="http://www.w3.org/2000/svg" width="0.88rem" height="1rem" viewBox="0 0 448 512"><path fill="currentColor" d="M0 256a56 56 0 1 1 112 0a56 56 0 1 1-112 0m168 0a56 56 0 1 1 112 0a56 56 0 1 1-112 0m224-56a56 56 0 1 1 0 112a56 56 0 1 1 0-112" /></svg></span>
          </button>
          <div class="hidden md:inline px-2 py-1.5 text-zinc-700 dark:text-[#768390] hover:text-zinc-900 dark:hover:text-[#adbac7] text-sm ml-auto">
            <span class="mt-footer-date" data-created-at="${post.created_at}">
              <a href="${post.url || 'https://e5n.cc/@eallion'}" target="_blank" rel="noopener noreferrer" class="no-underline text-zinc-600 dark:text-[#768390] hover:text-zinc-900 dark:hover:text-[#adbac7]">-</a>
            </span>
          </div>
        </div>
      `;

      postsWrapper.appendChild(article);
    });

    // è§¦å‘ blurhash æ¸²æŸ“
    window.renderBlurhashCanvases?.();
    // åˆ·æ–°ç›¸å¯¹æ—¶é—´
    updateRelativeTimes();

    // è§¦å‘ ViewImage åˆå§‹åŒ–
    window.ViewImage?.init('.mt-images-container a');
  }

  /**
   * æ˜¾ç¤ºé”™è¯¯çŠ¶æ€ï¼ˆå¤ç”¨åŸæœ‰çš„åŠ è½½æŒ‡ç¤ºå™¨ï¼‰
   */
  function renderErrorStatus(isTimeout = false) {
    const loadingSpinner = document.getElementById('mt-loading-spinner');
    if (loadingSpinner && loadingSpinner.style.display !== 'none') {
      const img = loadingSpinner.querySelector('img');
      const span = loadingSpinner.querySelector('span');
      if (img) {
        img.src = '/assets/images/mastodon/oops.gif';
      }
      if (span) {
        span.textContent = isTimeout ? 'Timeout' : 'Error';
      }
    }
  }

  /**
   * éšè—åŠ è½½æç¤º
   */
  function hideLoadingSpinner() {
    const loadingSpinner = document.getElementById('mt-loading-spinner');
    if (loadingSpinner) {
      loadingSpinner.style.display = 'none';
    }
  }

  /**
   * å¼ºåˆ¶æ¸²æŸ“æ–°æ•°æ®
   */
  function loadNewContent() {
    const pendingDataString = localStorage.getItem(PENDING_KEY);
    const updateButtonPlaceholder = document.getElementById('mt-update-button-placeholder');
    const cachedString = localStorage.getItem(CACHE_KEY);

    if (pendingDataString) {
      const pendingItem = JSON.parse(pendingDataString);

      // 1. æ¸²æŸ“æ–°å†…å®¹
      renderContent(pendingItem.data);

      // 2. å°†æ–°å†…å®¹æ›´æ–°ä¸ºå½“å‰ç¼“å­˜ (å°† pending æå‡ä¸º CACHE_KEY)
      localStorage.setItem(CACHE_KEY, JSON.stringify(pendingItem));
      localStorage.removeItem(PENDING_KEY);

      // 3. éšè—æ›´æ–°æŒ‰é’®
      updateButtonPlaceholder.innerHTML = '';
      updateButtonPlaceholder.classList.add('hidden');

      console.log('Mastodon: New content loaded and rendered by user action.');

      // æ»šåŠ¨åˆ°é¡¶éƒ¨
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } else if (cachedString) {
      // å¦‚æœç”¨æˆ·ç‚¹å‡»ä½†æ²¡æœ‰ pending å†…å®¹ï¼Œå¯èƒ½åªæ˜¯éœ€è¦é‡æ–°æ¸²æŸ“ï¼Œæˆ–è€…æ¸…ç©ºæŒ‰é’®
      const cached = JSON.parse(cachedString);
      renderContent(cached.data);
      updateButtonPlaceholder.innerHTML = '';
      updateButtonPlaceholder.classList.add('hidden');
    }
  }

  /**
   * åœ¨é¡µé¢é¡¶éƒ¨æ˜¾ç¤ºæ›´æ–°æŒ‰é’®
   * @param {number} newCount - æ–°å˜Ÿæ–‡çš„æ•°é‡
   */
  function showUpdateButton(newCount) {
    const updateButtonPlaceholder = document.getElementById('mt-update-button-placeholder');
    if (updateButtonPlaceholder && updateButtonPlaceholder.classList.contains('hidden')) {
      const countText = newCount > 0 ? `${newCount} æ¡æ–°å˜Ÿæ–‡` : 'å˜Ÿæ–‡å·²æ›´æ–°';

      updateButtonPlaceholder.innerHTML = `
        <div class="flex items-center justify-center w-fit mx-auto border dark:border-[#444c56] rounded-full px-6 py-2 hover:bg-zinc-200 dark:hover:bg-[#252a33] cursor-pointer" onclick="loadNewContent()">
            <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="16" stroke-dashoffset="16" d="M12 3c4.97 0 9 4.03 9 9"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="16;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path><path stroke-dasharray="64" stroke-dashoffset="64" stroke-opacity="0.3" d="M12 3c4.97 0 9 4.03 9 9c0 4.97 -4.03 9 -9 9c-4.97 0 -9 -4.03 -9 -9c0 -4.97 4.03 -9 9 -9Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.2s" values="64;0"/></path></g></svg>
            <span>ç‚¹å‡»æŸ¥çœ‹ ${countText}</span>
        </div>
      `;
      updateButtonPlaceholder.classList.remove('hidden');
    }
  }

  /**
   * æ ¸å¿ƒï¼šå‘ Mastodon API å‘èµ·è¯·æ±‚ï¼Œå¤„ç† ETag å’Œç¼“å­˜é€»è¾‘
   * @param {boolean} isForegroundCheck - æ˜¯å¦ä¸ºå®šæ—¶å™¨æˆ–å¯è§æ€§æ£€æŸ¥
   * @returns {Array|null} - é¦–æ¬¡åŠ è½½æˆ–ç¼“å­˜è¿‡æœŸç›´æ¥æ¸²æŸ“æ—¶è¿”å›æ•°æ®æ•°ç»„ï¼Œå¦åˆ™è¿”å› null
   */
  async function fetchAndCacheData(isForegroundCheck = false) {
    const cachedString = localStorage.getItem(CACHE_KEY);
    const cached = cachedString ? JSON.parse(cachedString) : {};
    const etag = cached.etag || null;

    // å½“éé¦–æ¬¡åŠ è½½æ—¶ï¼Œå¦‚æœæœ‰ pending æ•°æ®ï¼Œåˆ™ä½¿ç”¨ pending çš„ ETag è¿›è¡Œæ›´æ–°æ£€æŸ¥
    const pendingUpdate = localStorage.getItem(PENDING_KEY);
    const currentEtag = pendingUpdate ? JSON.parse(pendingUpdate).etag : etag;

    const headers = currentEtag ? { 'If-None-Match': currentEtag } : {};

    try {
      const response = await fetch(API_URL, { headers });

      // 1. ETag å‘½ä¸­ï¼šå†…å®¹æœªæ›´æ–° (304 Not Modified)
      if (response.status === 304) {
        console.log('Mastodon: Cache hit (304), content unchanged.');

        // ç¡®ä¿ Pending çŠ¶æ€ä¹Ÿè¢«æ¸…é™¤ (å†…å®¹æœªå˜ï¼ŒæŒ‰é’®åº”æ¶ˆå¤±)
        if (localStorage.getItem(PENDING_KEY)) {
          localStorage.removeItem(PENDING_KEY);
          const updateButtonPlaceholder = document.getElementById('mt-update-button-placeholder');
          if (updateButtonPlaceholder) {
            updateButtonPlaceholder.innerHTML = '';
            updateButtonPlaceholder.classList.add('hidden');
          }
        }

        // æ›´æ–°ä¸»ç¼“å­˜çš„æ—¶é—´æˆ³ï¼Œå»¶é•¿ 7 å¤©æœ‰æ•ˆæœŸ (ä»…å½“ä¸»ç¼“å­˜å­˜åœ¨æ—¶)
        if (cachedString) {
          localStorage.setItem(CACHE_KEY, JSON.stringify({ ...cached, timestamp: Date.now() }));
        }
        return null;
      }

      // 2. å†…å®¹å·²æ›´æ–° (200 OK)
      if (response.ok) {
        const data = await response.json();
        const newEtag = response.headers.get('ETag') || (new Date()).getTime().toString();
        const newCacheItem = {
          data: data,
          timestamp: Date.now(),
          etag: newEtag
        };

        if (isForegroundCheck && cached.data && data.length > 0) {
          // æ˜¯å‰å°æ£€æŸ¥ï¼Œå¹¶ä¸”å½“å‰é¡µé¢æœ‰å†…å®¹

          // æ¯”è¾ƒç¬¬ä¸€æ¡å˜Ÿæ–‡ ID æ˜¯å¦å˜åŒ– (ç®€å•é«˜æ•ˆçš„åˆ¤æ–­æ˜¯å¦æœ‰æ–°å†…å®¹)
          const isNewContent = data[0].id !== cached.data[0].id;

          if (isNewContent) {
            // å­˜å‚¨åˆ° Pending Key
            localStorage.setItem(PENDING_KEY, JSON.stringify(newCacheItem));

            // ç²—ç•¥è®¡ç®—æ–°å˜Ÿæ–‡æ•°é‡
            const cachedIds = new Set(cached.data.map(post => post.id));
            let newCount = data.filter(post => !cachedIds.has(post.id)).length;

            showUpdateButton(newCount);
            console.log(`Mastodon: New content found (${newCount} new posts), showing update button.`);
            return null; // ä¸ç«‹å³æ¸²æŸ“
          } else {
            // å†…å®¹ç›¸åŒï¼Œæ›´æ–°ä¸»ç¼“å­˜çš„æ—¶é—´æˆ³å’Œ ETag (é˜²æ­¢ä¸‹æ¬¡ç«‹å³è¿‡æœŸ)
            localStorage.setItem(CACHE_KEY, JSON.stringify(newCacheItem));
            localStorage.removeItem(PENDING_KEY);
            return null;
          }
        } else {
          // é¦–æ¬¡åŠ è½½æˆ–ç¼“å­˜è¿‡æœŸï¼Œç›´æ¥æ¸²æŸ“å¹¶æ›´æ–°ä¸»ç¼“å­˜
          localStorage.setItem(CACHE_KEY, JSON.stringify(newCacheItem));
          localStorage.removeItem(PENDING_KEY);
          return data; // è¿”å›æ•°æ®ä¾› DOM æ¸²æŸ“
        }
      } else {
        // API é”™è¯¯
        throw new Error(`API returned status ${response.status}`);
      }
    } catch (error) {
      console.error('Error fetching Mastodon data:', error);
      // åå°æ£€æŸ¥å‡ºé”™ï¼Œä¸å½±å“é¡µé¢æ˜¾ç¤º
      if (!isForegroundCheck) {
        renderErrorStatus();
      }
      return null;
    }
  }

  /**
   * å¯åŠ¨æˆ–åœæ­¢ 1 åˆ†é’Ÿçš„å®šæ—¶æ›´æ–°æ£€æŸ¥ (ç”¨äº Page Visibility API)
   */
  function toggleUpdateCheck() {
    // 1. åœæ­¢ç°æœ‰å®šæ—¶å™¨
    if (updateTimer) {
      clearInterval(updateTimer);
      updateTimer = null;
    }

    // 2. å¦‚æœé¡µé¢å¯è§ï¼Œåˆ™å¯åŠ¨å®šæ—¶å™¨
    if (document.visibilityState === 'visible') {
      // ç«‹å³æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥ (ç”¨äºç”¨æˆ·ä»å…¶ä»–é¡µé¢åˆ‡æ¢å›æ¥)
      fetchAndCacheData(true);

      // å¯åŠ¨å®šæ—¶å™¨ï¼Œæ¯ 1 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
      updateTimer = setInterval(() => {
        fetchAndCacheData(true); // å‰å°æ£€æŸ¥ï¼Œä¸ç«‹å³æ¸²æŸ“ï¼Œåªæ˜¾ç¤ºæŒ‰é’®
      }, UPDATE_INTERVAL);

      console.log('Mastodon: Background update check started (1 min interval).');
    } else {
      console.log('Mastodon: Background update check stopped (page hidden).');
    }
  }


  // --- Page Initialization ---
  document.addEventListener('DOMContentLoaded', async () => {
    let cached = null;
    let cacheValid = false;

    // å°è¯•è·å–ç°æœ‰ç¼“å­˜
    const cachedString = localStorage.getItem(CACHE_KEY);
    if (cachedString) {
      cached = JSON.parse(cachedString);
      // æ£€æŸ¥ 7 å¤©ç¼“å­˜æ˜¯å¦è¿‡æœŸ
      if (Date.now() - cached.timestamp < CACHE_LIFETIME) {
        cacheValid = true;
      }
    }

    const pendingUpdate = localStorage.getItem(PENDING_KEY);

    if (cacheValid || pendingUpdate) {
      // 1. ç¼“å­˜æœ‰æ•ˆæˆ–æœ‰å¾…å¤„ç†æ›´æ–°ï¼Œç«‹å³æ¸²æŸ“ç¼“å­˜å†…å®¹
      if (cached?.data) {
        renderContent(cached.data);
        console.log('Mastodon: Loaded from local cache.');
      } else if (pendingUpdate) { // ç¼“å­˜è¿‡æœŸï¼Œä½†æœ‰ pendingï¼Œæ¸²æŸ“ pending æ•°æ®å¹¶å°†å…¶æå‡ä¸º cache key
        const pendingItem = JSON.parse(pendingUpdate);
        renderContent(pendingItem.data);
        localStorage.setItem(CACHE_KEY, JSON.stringify(pendingItem));
        localStorage.removeItem(PENDING_KEY);
        console.log('Mastodon: Cache expired, loaded from pending data.');
      }

      hideLoadingSpinner();

      // å¦‚æœæœ‰å¾…å¤„ç†æ›´æ–°ï¼Œåˆ™æ˜¾ç¤ºæ›´æ–°æŒ‰é’® (åœ¨æ¸²æŸ“å®Œå†…å®¹å)
      if (pendingUpdate) {
        showUpdateButton(1); // ç²—ç•¥æ˜¾ç¤ºæœ‰æ›´æ–°
      }

      // 2. è®¾ç½® Page Visibility ç›‘å¬ï¼Œæ§åˆ¶ 1 åˆ†é’Ÿæ›´æ–°
      document.addEventListener('visibilitychange', toggleUpdateCheck);
      toggleUpdateCheck(); // é¦–æ¬¡å¯åŠ¨æ£€æŸ¥ (ä¼šæ£€æŸ¥æ˜¯å¦æœ‰æ–°å†…å®¹ï¼Œä½†ä¸æ¸²æŸ“)

    } else {
      // 3. ç¼“å­˜è¿‡æœŸæˆ–ä¸å­˜åœ¨ï¼Œé¦–æ¬¡å‘èµ·ç½‘ç»œè¯·æ±‚ï¼Œè·å–æœ€æ–°æ•°æ®å¹¶æ¸²æŸ“
      const newData = await fetchAndCacheData(false); // é¦–æ¬¡åŠ è½½ï¼Œå¤±è´¥ä¼šæ˜¾ç¤ºé”™è¯¯

      if (newData) {
        // *** ä¿®å¤ç‚¹ï¼šæ·»åŠ äº†å¯¹é¦–æ¬¡è·å–æ•°æ®çš„æ¸²æŸ“è°ƒç”¨ ***
        renderContent(newData);

        // æ¸²æŸ“æˆåŠŸï¼Œè®¾ç½®ç›‘å¬å™¨
        document.addEventListener('visibilitychange', toggleUpdateCheck);
        toggleUpdateCheck(); // å¯åŠ¨æ£€æŸ¥
      }

      hideLoadingSpinner();
    }

    // åŸæœ‰çš„ 30 ç§’è¶…æ—¶å¤„ç†ï¼Œç°åœ¨åªå¤„ç†é¦–æ¬¡åŠ è½½å¤±è´¥çš„æƒ…å†µ
    setTimeout(() => {
      const hasPosts = document.getElementById('mt-posts-wrapper')?.children.length > 0;
      const pending = localStorage.getItem(PENDING_KEY);

      // å¦‚æœé¡µé¢æ²¡æœ‰å†…å®¹ï¼Œä¹Ÿæ²¡æœ‰ç¼“å­˜ï¼Œä¸”åŠ è½½æç¤ºä»æ˜¾ç¤ºï¼Œåˆ™æ˜¾ç¤ºè¶…æ—¶é”™è¯¯
      if (!hasPosts && !pending && document.getElementById('mt-loading-spinner').style.display !== 'none') {
        renderErrorStatus(true);
      }
    }, 30000);
  });
</script>

{{ $fastBlurhashJS := resources.Get "js/fast-blurhash.min.js" | fingerprint "sha256" }}
<script type="module">
  import { decodeBlurHash } from '{{ $fastBlurhashJS.RelPermalink }}?v=1.1.4';

  window.renderBlurhashCanvases = async function () {
    const canvases = document.querySelectorAll('canvas[data-blurhash]');

    for (const canvas of canvases) {
      const blurhash = canvas.getAttribute('data-blurhash');
      if (!blurhash) continue;

      const pixels = decodeBlurHash(blurhash, 32, 32);

      canvas.width = 32;
      canvas.height = 32;

      const ctx = canvas.getContext('2d');
      const imageData = new ImageData(pixels, 32, 32);
      ctx.putImageData(imageData, 0, 0);
    }
  }

  function setupObserver() {
    const observer = new MutationObserver(mutations => {
      let shouldRender = false;

      mutations.forEach(mutation => {
        if (mutation.type !== 'childList') return;

        mutation.addedNodes.forEach(node => {
          if (node.nodeName === 'CANVAS' && node.dataset.blurhash) {
            shouldRender = true;
          }
          if (node.querySelectorAll) {
            const canvases = node.querySelectorAll('canvas[data-blurhash]');
            if (canvases.length > 0) shouldRender = true;
          }
        });
      });

      // ä»…åœ¨ DOM æ›´æ–°æ—¶è§¦å‘ä¸€æ¬¡æ¸²æŸ“
      if (shouldRender) window.renderBlurhashCanvases();
    });

    observer.observe(document.documentElement, {
      childList: true,
      subtree: true
    });

    window.renderBlurhashCanvases();
  }

  document.addEventListener('DOMContentLoaded', setupObserver);
</script>

{{ $viewJS := resources.Get "js/view-image.min.js" | fingerprint "sha256" }}
<script type="text/javascript" src="{{ $viewJS.RelPermalink }}" integrity="{{ $viewJS.Data.Integrity }}"></script>

{{ end }}
