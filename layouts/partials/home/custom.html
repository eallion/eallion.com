{{ $disableImageOptimization := .Site.Params.disableImageOptimization | default false }}

<meta http-equiv="onion-location" content="http://eallionskii7e32j3ncxnccyqq6uf7rbxwmst4x6mxeswx6fvrdtsmad.onion" />

<article class="max-w-full prose dark:prose-invert">
    <div class="relative">
        <div class="absolute inset-x-0 bottom-0 h-1/2 bg-gray-100"></div>
        <div class="mx-auto max-w-7xl p-0">
            <div class="relative sm:overflow-hidden">
                <div class="fixed inset-x-0 top-0" style="z-index:-10">
                    {{ $homepageImage := "" }}
                    {{ with .Site.Params.defaultBackgroundImage }}
                        {{ if or (strings.HasPrefix . "http:") (strings.HasPrefix . "https:") }}
                            {{ $homepageImage = resources.GetRemote . }}
                        {{ else }}
                            {{ $homepageImage = resources.Get . }}
                        {{ end }}
                    {{ end }}
                    {{ with .Site.Params.homepage.homepageImage }}
                        {{ if or (strings.HasPrefix . "http:") (strings.HasPrefix . "https:") }}
                            {{ $homepageImage = resources.GetRemote . }}
                        {{ else }}
                            {{ $homepageImage = resources.Get . }}
                        {{ end }}
                    {{ end }}
                    {{ if $homepageImage }}
                    <img class="w-full h-[1000px] object-cover m-0 nozoom" src="{{ $homepageImage.RelPermalink }}" role="presentation">
                    <div
                        class="absolute inset-0 h-[1000px] bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal">
                    </div>
                    <div
                        class="opacity-60 absolute inset-0 h-[1000px] bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal">
                    </div>
                    {{ end }}
                </div>
                <div class="relative px-1 py-1 flex flex-col items-center justify-center text-center">
                    {{ with .Site.Author.image }}
                        {{ $authorImage := "" }}
                        {{ if or (strings.HasPrefix . "http:") (strings.HasPrefix . "https:") }}
                            {{ $authorImage = resources.GetRemote . }}
                        {{ else }}
                            {{ $authorImage = resources.Get . }}
                        {{ end }}
                        {{ if $authorImage }}
                            {{ if not $disableImageOptimization }}
                                {{ $authorImage = $authorImage.Fill "288x288" }}
                            {{ end }}
                            <div class="tailwind-ticker w-auto relative group flex items-end transition-all duration-300">
                                <div class="rounded-full overflow-hidden min-w-[144px]">
                                    <img class="mb-2 rounded-full h-36 w-36 nozoom" width="144" height="144"
                                    alt="{{ $.Site.Author.name | default " Author" }}" src="{{ $authorImage.RelPermalink }}" />
                                </div>
                                <div class="absolute bottom-0 left-full -ml-9 mb-1 w-8 h-8 rounded-full flex items-center justify-center group-hover:w-min group-hover:h-8 group-hover:rounded-lg transition-all duration-300">
                                    <div class="ticker w-9 sm:w-[226px] md:w-[295px] lg:w-[476px] min-w-[36px] transition-all duration-300">
                                        <div id="ticker"></div>
                                    </div>
                                </div>
                            </div>

                        {{ end }}
                    {{ end }}
                    <h1 class="mb-2 text-4xl font-extrabold text-neutral-800 dark:text-neutral-200">
                        {{ .Site.Author.name | default .Site.Title }}
                        {{/*  {{ T `blog_title` | safeHTML }}  */}}
                    </h1>
                    {{/*  {{ with .Site.Author.headline }}  */}}
                    <h2 class="mt-0 mb-0 text-xl text-neutral-800 dark:text-neutral-300">
                        {{/*  {{ . | markdownify }}  */}}
                        <div id="poem_sentence" class="min-h-7">{{ partial "icon.html" "loading" }}</div>
                        {{/*  <div>{{ T `toot_motto` | safeHTML }} - <span class="italic text-base">Louis Pasteur</span></div>  */}}
                    </h2>
                    {{/*  {{ end }}  */}}
                    <div class="my-3 text-2xl">
                        {{ with .Site.Author.links }}
                        <div class="flex flex-wrap">
                            {{ range $links := . }}
                            {{ range $name, $url := $links }}
                            <a class="px-1 hover:text-primary-400 text-primary-800 dark:text-primary-200" href="{{ $url }}" target="_blank"
                                aria-label="{{ $name | title }}" rel="me noopener noreferrer">{{ partial
                                "icon.html" $name }}</a>
                            {{ end }}
                            {{ end }}
                        </div>
                        {{ end }}
                    </div>

                    <div class="tailwindcss-heatmap flex flex-col items-end text-[10px] leading-[12px] text-neutral-700 dark:text-neutral-400">
                        <div class="flex flex-row items-end">

                            <div class="flex flex-col justify-end items-end mr-1 mt-1 text-right">
                                <span>Mon</span>
                                <span>&nbsp;</span>
                                <span>Wed</span>
                                <span>&nbsp;</span>
                                <span>Fri</span>
                                <span>&nbsp;</span>
                                <span>Sun</span>
                            </div>

                            <div class="heatmap">
                                <div class="month mb-1 flex justify-around">
                                </div>
                                <div class="h-[84px]">
                                    <div id="heatmap" class="flex flex-row"></div>
                                </div>
                            </div>

                        </div>

                        <div class="flex mt-2 items-center">
                            <span class="">{{ T `heatmap_less` | safeHTML }}</span>
                            <div class="flex flex-row items-center gap-[2px] w-max h-[10px] mx-1">
                                <span class="block w-[10px] h-[10px] rounded-sm bg-[#ebedf0] dark:bg-[#161b22]"></span>
                                <span class="block w-[10px] h-[10px] rounded-sm bg-[#9be9a8] dark:bg-[#0e4429]"></span>
                                <span class="block w-[10px] h-[10px] rounded-sm bg-[#40c463] dark:bg-[#006d32]"></span>
                                <span class="block w-[10px] h-[10px] rounded-sm bg-[#30a14e] dark:bg-[#26a641]"></span>
                                <span class="block w-[10px] h-[10px] rounded-sm bg-[#216e39] dark:bg-[#39d353]"></span>
                            </div>
                            <span class="">{{ T `heatmap_more` | safeHTML }}</span>
                        </div>

                    </div>

                    <script type="text/javascript">
                        // 获取最近一年的文章数据
                        {{ $pages := where .Site.RegularPages "Date" ">" (now.AddDate -1 0 0) }}
                        {{ $pages := $pages.Reverse }}
                        var blogInfo = {
                            "pages": [
                                {{ range $index, $element := $pages }}
                                    {
                                        "title": "{{ replace (replace .Title "《" "〈") "》" "〉" }}",
                                        "date": "{{ .Date.Format "2006-01-02" }}",
                                        "year": "{{ .Date.Format "2006" }}",
                                        "month": "{{ .Date.Format "01" }}",
                                        "day": "{{ .Date.Format "02" }}",
                                        "word_count": "{{ .WordCount }}"
                                    }{{ if ne (add $index 1) (len $pages) }},{{ end }}
                                    {{ end }}
                            ]
                        };
                        // console.log(blogInfo)

                        let currentDate = new Date();
                        currentDate.setFullYear(currentDate.getFullYear() - 1);

                        let startDate;

                        let monthDiv = document.querySelector('.month');
                        let monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                        if (window.innerWidth < 768) {
                            numMonths = 6;
                        } else {
                            numMonths = 12;
                        }

                        let startMonthIndex = (currentDate.getMonth() - (numMonths - 1) + 12) % 12;
                        for (let i = startMonthIndex; i < startMonthIndex + numMonths; i++) {
                            let monthSpan = document.createElement('span');
                            let monthIndex = i % 12;
                            monthSpan.textContent = monthNames[monthIndex];
                            monthDiv.appendChild(monthSpan);
                        }

                        function getStartDate() {
                            const today = new Date();

                            if (window.innerWidth < 768) {
                                numMonths = 6;
                            } else {
                                numMonths = 12;
                            }

                            const startDate = new Date(today.getFullYear(), today.getMonth() - numMonths + 1, 1, today.getHours(), today.getMinutes(), today.getSeconds());

                            while (startDate.getDay() !== 1) {
                                startDate.setDate(startDate.getDate() + 1);
                            }

                            return startDate;
                        }

                        function getWeekDay(date) {
                            const day = date.getDay();
                            return day === 0 ? 6 : day - 1;
                        }

                        function createDay(date, title, count, post) {
                            const day = document.createElement("div");

                            day.className = "heatmap_day";

                            day.setAttribute("data-title", title);
                            day.setAttribute("data-count", count);
                            day.setAttribute("data-post", post);
                            day.setAttribute("data-date", date);

                            day.addEventListener("mouseenter", function () {
                                const tooltip = document.createElement("div");
                                tooltip.className = "heatmap_tooltip";

                                let tooltipContent = "";

                                if (post && parseInt(post, 10) !== 0) {
                                    tooltipContent += '<span class="heatmap_tooltip_post">' + '共 ' + post + ' 篇' + '</span>';
                                }

                                if (count && parseInt(count, 10) !== 0) {
                                    tooltipContent += '<span class="heatmap_tooltip_count">' + ' ' + count + ' 字；' + '</span>';
                                }

                                if (title && parseInt(title, 10) !== 0) {
                                    tooltipContent += '<span class="heatmap_tooltip_title">' + title + '</span>';
                                }

                                if (date) {
                                    tooltipContent += '<span class="heatmap_tooltip_date">' + date + '</span>';
                                }

                                tooltip.innerHTML = tooltipContent;
                                day.appendChild(tooltip);
                            });

                            day.addEventListener("mouseleave", function () {
                                const tooltip = day.querySelector(".heatmap_tooltip");
                                if (tooltip) {
                                    day.removeChild(tooltip);
                                }
                            });

                            if (count == 0 ) {
                                day.classList.add("heatmap_day_level_0");
                            } else if (count > 0 && count < 1000) {
                                day.classList.add("heatmap_day_level_1");
                            } else if (count >= 1000 && count < 2000) {
                                day.classList.add("heatmap_day_level_2");
                            } else if (count >= 2000 && count < 3000) {
                                day.classList.add("heatmap_day_level_3");
                            } else {
                                day.classList.add("heatmap_day_level_4");
                            }

                            return day;
                        }

                        function createWeek() {
                            const week = document.createElement('div');
                            week.className = 'heatmap_week';
                            return week;
                        }

                        function createHeatmap() {
                            const container = document.getElementById('heatmap');
                            const startDate = getStartDate();
                            const endDate = new Date();
                            const weekDay = getWeekDay(startDate);

                            let currentWeek = createWeek();
                            container.appendChild(currentWeek);

                            let currentDate = startDate;
                            let i = 0;

                            while (currentDate <= endDate) {
                                if (i % 7 === 0 && i !== 0) {
                                    currentWeek = createWeek();
                                    container.appendChild(currentWeek);
                                }

                                const dateString = `${currentDate.getFullYear()}-${("0" + (currentDate.getMonth()+1)).slice(-2)}-${("0" + (currentDate.getDate())).slice(-2)}`;

                                const articleDataList = blogInfo.pages.filter(page => page.date === dateString);

                                if (articleDataList.length > 0) {
                                    const titles = articleDataList.map(data => data.title);
                                    const title = titles.map(t => `《${t}》`).join('<br />');

                                    let count = 0;
                                    let post = articleDataList.length;

                                    articleDataList.forEach(data => {
                                        count += parseInt(data.word_count, 10);
                                    });

                                    const formattedDate = formatDate(currentDate);
                                    const day = createDay(formattedDate, title, count, post);
                                    currentWeek.appendChild(day);
                                } else {
                                    const formattedDate = formatDate(currentDate);
                                    const day = createDay(formattedDate, '', '0', '0');
                                    currentWeek.appendChild(day);
                                }

                                i++;
                                currentDate.setDate(currentDate.getDate() + 1);
                            }
                        }

                        function formatDate(date) {
                            const options = { month: 'short', day: 'numeric', year: 'numeric' };
                            return date.toLocaleDateString('en-US', options);
                        }

                        createHeatmap();

                    </script>

                    <section class="prose dark:prose-invert">{{ .Content }}</section>

                </div>
            </div>
        </div>
    </div>
</article>
<section>
    {{ $recentArticles := 5 }}
    {{ $showMoreLinkDest := "/posts" }}
    {{ if .Site.Params.homepage.showRecent | default false }}
    {{ if index .Site.Params.homepage "showRecentItems" }}
    {{ $recentArticles = .Site.Params.homepage.showRecentItems }}
    {{ end }}
    <h2 class="mt-8 text-2xl font-extrabold mb-10">{{ i18n "shortcode.recent_articles" }}</h2>

    {{ if and .Site.Params.homepage.cardView (not .Site.Params.homepage.cardViewScreenWidth) | default false }}
    {{ partial "recent-articles/cardview.html" . }}
    {{ else if and .Site.Params.homepage.cardView .Site.Params.homepage.cardViewScreenWidth | default false }}
    {{ partial "recent-articles/cardview-fullwidth.html" . }}
    {{ else }}
    {{ partial "recent-articles/list.html" . }}
    {{ end }}

    {{ if .Site.Params.homepage.showMoreLink | default false }}
    {{ if index .Site.Params.homepage "showRecentItems" }}
    {{ $showMoreLinkDest = .Site.Params.homepage.showMoreLinkDest }}
    {{ end }}
    <div class="mt-10 flex justify-center">
    <a href="{{ $showMoreLinkDest }}">
        <button
        class="bg-transparent hover:text-primary-500 prose dark:prose-invert font-semibold hover:text-white py-2 px-4 border border-primary-500 hover:border-transparent rounded">
        {{ i18n "recent.show_more" | markdownify }}
        </button>
    </a>
    </div>
    {{ end }}
    {{ end }}
</section>
{{ if .Site.Params.homepage.layoutBackgroundBlur | default false }}
<div id="background-blur" class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div>

<script type="text/javascript">
    /**
    * 今日诗词V2 JS-SDK 1.2.2
    * 今日诗词API 是一个可以免费调用的诗词接口：https://www.jinrishici.com
    */
    !function(e){var n,t={},o="jinrishici-token";function i(){return document.getElementById("jinrishici-sentence")||0!=document.getElementsByClassName("jinrishici-sentence").length}function c(){t.load(function(e){var n=document.getElementById("jinrishici-sentence"),t=document.getElementsByClassName("jinrishici-sentence");if(n&&(n.innerText=e.data.content),0!==t.length)for(var o=0;o<t.length;o++)t[o].innerText=e.data.content})}function r(e,n){var t=new XMLHttpRequest;t.open("get",n),t.withCredentials=!0,t.send(),t.onreadystatechange=function(n){if(4===t.readyState){var o=JSON.parse(t.responseText);"success"===o.status?e(o):console.error("今日诗词API加载失败，错误原因："+o.errMessage)}}}t.load=function(n){return e.localStorage&&e.localStorage.getItem(o)?function(e,n){return r(e,"https://v2.jinrishici.com/one.json?client=browser-sdk/1.2&X-User-Token="+encodeURIComponent(n))}(n,e.localStorage.getItem(o)):function(n){return r(function(t){e.localStorage.setItem(o,t.token),n(t)},"https://v2.jinrishici.com/one.json?client=browser-sdk/1.2")}(n)},e.jinrishici=t,i()?c():(n=function(){i()&&c()},"loading"!=document.readyState?n():document.addEventListener?document.addEventListener("DOMContentLoaded",n):document.attachEvent("onreadystatechange",function(){"complete"==document.readyState&&n()}))}(window);

    jinrishici.load(function(result) {
        var sentence = document.querySelector("#poem_sentence")
        sentence.innerHTML = result.data.content
    });

</script>

<script>
    // 远程 JSON API 地址
    let jsonUrl = "https://mastodon.api.eallion.com/api/v1/accounts/111136231674527355/statuses?limit=10&exclude_replies=true&exclude_reblogs=true";

    // 相对时间插件 2.5.2 https://tokinx.github.io/lately/
    (() => {
        window.Lately = new function () {
            this.lang = {
                second: " 秒",
                minute: " 分钟",
                hour: " 小时",
                day: " 天",
                month: " 个月",
                year: " 年",
                ago: "前",
                error: "NaN"
            };
            const format = (date) => {
                date = new Date(_val(date));
                const floor = (num, _lang) => Math.floor(num) + _lang,
                    obj = new function () {
                        this.second = (Date.now() - date.getTime()) / 1000;
                        this.minute = this.second / 60;
                        this.hour = this.minute / 60;
                        this.day = this.hour / 24;
                        this.month = this.day / 30;
                        this.year = this.month / 12
                    },
                    key = Object.keys(obj).reverse().find(_ => obj[_] >= 1);
                return (key ? floor(obj[key], this.lang[key]) : this.lang.error) + this.lang.ago;
            },
                _val = (date) => {
                    date = new Date(date && (typeof date === 'number' ? date : date.replace(/-/g, '/').replace('T', ' ')));
                    return isNaN(date.getTime()) ? false : date.getTime();
                };
            return {
                init: ({ target = "time", lang } = {}) => {
                    if (lang) this.lang = lang;
                    for (let el of document.querySelectorAll(target)) {
                        const date = _val(el.dateTime) || _val(el.title) || _val(el.innerHTML) || 0;
                        if (!date) return;
                        el.title = new Date(date).toLocaleString();
                        el.innerHTML = format(date);
                    }
                },
                format
            }
        }
    })();

    // 设置宽度
    // const heatmapElement = document.querySelector(".tailwindcss-heatmap");
    // const secondNavElement = mainMenuElement.querySelectorAll("nav")[1]; // 获取第二个nav元素
    // const heatmapWidth = secondNavElement.offsetWidth;
    // const heatmapWidth = heatmapElement.offsetWidth;
    // const tickerElement = document.querySelector(".tailwind-ticker");
    // tickerElement.style.maxWidth = `${heatmapWidth}px`;

    // 处理 Json 数据
    if (document.querySelector('#ticker')) {
        fetch(jsonUrl)
            .then(res => res.json())
            .then(res => {
                var result = '';
                var data = res;
                for (var i = 0; i < data.length; i++) {
                    var tickerTime = new Date(data[i].created_at).toLocaleString();
                    var tickerContent = extractTextFromHtml(data[i].content)
                    const replacements = {
                        '\\s*:star_empty:\\s*': '🌑',
                        '\\s*:star_half:\\s*': '🌗',
                        '\\s*:star_solid:\\s*': '🌕'
                    };
                    tickerContent = replaceMultiple(tickerContent, replacements);
                    result += `<li class="ticker-item"><span class="datetime">${tickerTime}</span>：<a href="https://www.eallion.com/mastodon/" target="_self">${tickerContent}</a></li>`;
                }
                var tickerDom = document.querySelector('#ticker');
                var tickerBefore = `<div class="ticker-wrap"><ul class="ticker-list">`;
                var tickerAfter = `</ul></div>`;
                resultAll = tickerBefore + result + tickerAfter;
                tickerDom.innerHTML = resultAll;

                // 相对时间插件
                window.Lately && Lately.init({
                    target: '.datetime'
                });
            });

        // 滚动效果
        setInterval(function () {
            var tickerWrap = document.querySelector(".ticker-list");
            var tickerItem = tickerWrap.querySelectorAll(".ticker-item");
            for (var i = 0; i < tickerItem.length; i++) {
                setTimeout(function () {
                    tickerWrap.appendChild(tickerItem[0]);
                }, 1500);
            }
        }, 1500);
    }

    // 替换字符串
    function replaceMultiple(str, replacements) {
        let result = str;
        for (const pattern in replacements) {
            const regex = new RegExp(pattern, 'g');
            result = result.replace(regex, replacements[pattern]);
        }
        return result;
    }

    // 提取 HTML 代码中的纯文本内容
    function extractTextFromHtml(html) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        return doc.body.textContent || '';
    }
</script>

<script>
    window.addEventListener('scroll', function (e) {
        var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
        var background_blur = document.getElementById('background-blur');
        background_blur.style.opacity = (scroll / 300)
    });

</script>
{{ end }}
