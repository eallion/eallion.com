{{ define "main" }}

<div class="posts post post-content talks">
    <h2 class="post-title">{{ .Title }}</h2>
    <blockquote class="hidden">Kesoï¼šâ€œæˆ‘æŒ‰æˆ‘çš„å…´è¶£å†™ï¼Œä½ ç”¨ä½ çš„æ™ºå•†è¯»ã€‚æˆ‘æ²¡æœ‰å…´è¶£è¯¯å¯¼è°ï¼Œå˜€å’•é¡µé¢è°¢ç»äº’åŠ¨ã€‚â€</blockquote>
    <div class="talks__search">
        <div class="count">
            <p>å…±å˜€å’•äº† <span id="memosCount"><i class="iconfont icon-loading"></i></span> æ¡ Memos <span class="emoji">ğŸ‰</span></p>
        </div>
        <div class="search-talks">
            <input type="text" class="search-input" id="talkSearch" placeholder="æœç´¢åŠŸèƒ½é‡æ„ä¸­ï¼ˆå‡çš„ï¼‰â€¦â€¦">
            <button class="search-btn">
                <i class="iconfont icon-search"></i>
            </button>
            <button class="search-clear" onclick="clearInput()">
                <i class="iconfont icon-clear"></i>
            </button>
        </div>
    </div>
    <div id="memos">
        <!-- å˜€å’•åŠ è½½åœ¨è¿™é‡Œ -->
    </div>
</div>
<script>
    // ä»Šæ—¥è¯—è¯
    function getData() {
        var xhr = new XMLHttpRequest();
        xhr.open('get', 'https://v2.jinrishici.com/one.json', true);
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                var result = JSON.parse(xhr.responseText);
                var title = document.getElementById('poemTitle');
                var poemSentence = document.getElementById('poemSentence');
                var poem_info = document.getElementById('poem_info');
                title.innerHTML = 'ã€Š<a href="https://www.google.com/search?q=' + result.data.origin.author + ' ' + result.data.origin.title + '" target="_blank" rel="noopener noreferrer">' + result.data.origin.title + '</a>ã€‹ï¼š';
                poemSentence.innerHTML = 'ã€Œ<a href="https://www.google.com/search?q=' + result.data.content + '" target="_blank" rel="noopener noreferrer">' + result.data.content + '</a>ã€';
                poem_info.innerHTML = 'ã€' + result.data.origin.dynasty + 'ã€‘' + result.data.origin.author;
            }
        };
        xhr.send();
    }
    // æ¯ 10 åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡ ï¼ˆåˆ«è¿™æ ·è®¾ç½®ï¼Œä¼šè¢«æœåŠ¡å™¨ BANï¼‰
    // setInterval(getData, 1000*600);
    window.onload = getData();

</script>
<script>
    //è·å– Memos æ€»æ¡æ•°
    function getTotal() {
        var totalUrl = "https://memos.eallion.com/api/memo/amount?creatorId=101";
        fetch(totalUrl).then(response => {
            return response.json();
        }).then(data => {
            // console.log(data.data);
            var memosCount = document.getElementById('memosCount');
            memosCount.innerHTML = data.data;
        }).catch(err => {
            // Do something for an error here
        });
    };
    window.onload = getTotal();

</script>
<script type="text/javascript" src="https://cdn.staticfile.org/marked/4.2.2/marked.min.js"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/pangu/4.0.7/pangu.min.js"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/moment.js/2.29.4/moment.min.js"></script>
<script>
    // å¤„ç†å‘å¸ƒæ—¶é—´ moment.js
    // moment.js locale
    moment.updateLocale('zh-cn', {
        meridiem: function (hour, minute, isLowercase) {
            if (hour < 6) {
                return "å‡Œæ™¨";
            } else if (hour < 9) {
                return "æ—©ä¸Š";
            } else if (hour < 11 && minute < 30) {
                return "ä¸Šåˆ";
            } else if (hour < 13 && minute < 30) {
                return "ä¸­åˆ";
            } else if (hour < 18) {
                return "ä¸‹åˆ";
            } else {
                return "æ™šä¸Š";
            }
        }
    });
    // moment.js twitter plugin
    (function () {
        var day, formats, hour, initialize, minute, second, week;
        second = 1e3;
        minute = 6e4;
        hour = 36e5;
        day = 864e5;
        week = 6048e5;
        year = new Date().getFullYear();
        formats = {
            seconds: {
                short: ' ç§’å‰',
                long: ' ç§’å‰'
            },
            minutes: {
                short: ' åˆ†å‰',
                long: ' åˆ†å‰'
            },
            hours: {
                short: ' å°æ—¶å‰',
                long: ' å°æ—¶å‰'
            },
            days: {
                short: ' å¤©å‰',
                long: ' å¤©å‰'
            }
        };

        initialize = function (moment) {
            var twitterFormat;
            twitterFormat = function (format) {
                var diff, num, unit, unitStr;
                diff = Math.abs(this.diff(moment()));
                unit = null;
                num = null;
                if (diff <= second) {
                    unit = 'seconds';
                    num = 1;
                } else if (diff < minute) {
                    unit = 'seconds';
                } else if (diff < hour) {
                    unit = 'minutes';
                } else if (diff < day) {
                    unit = 'hours';
                } else if (format === 'short') {
                    if (diff < week) {
                        unit = 'days';
                    } else if (this.year() == year) {
                        return this.format('MMæœˆDDæ—¥ï¼ŒHH:mm â€¢ a ');
                    } else {
                        return this.format('YYYYå¹´MMæœˆDDæ—¥ï¼ŒHH:mm â€¢ a ');
                    }
                } else {
                    return this.format('YYYYå¹´MMæœˆDDæ—¥ï¼ŒHH:mm â€¢ a ');
                }
                if (!(num && unit)) {
                    num = moment.duration(diff)[unit]();
                }
                unitStr = unit = formats[unit][format];
                if (format === 'long' && num > 1) {
                    unitStr += 's';
                }
                return num + unitStr;
            };
            moment.fn.twitterLong = function () {
                return twitterFormat.call(this, 'long');
            };
            moment.fn.twitter = moment.fn.twitterShort = function () {
                return twitterFormat.call(this, 'short');
            };
            return moment;
        };

        if (typeof define === 'function' && define.amd) {
            define('moment-twitter', ['moment'], function (moment) {
                return this.moment = initialize(moment);
            });
        } else if (typeof module !== 'undefined') {
            module.exports = initialize(require('moment'));
        } else if (typeof window !== "undefined" && window.moment) {
            this.moment = initialize(this.moment);
        }

    }).call(this);

</script>
<script type="text/javascript">
    var bbMemos = {
        memos: 'https://memos.eallion.com/', //ä¿®æ”¹ä¸ºè‡ªå·±éƒ¨ç½² Memos çš„ç½‘å€ï¼Œæœ«å°¾æœ‰ / æ–œæ 
        limit: '10', //é»˜è®¤æ¯æ¬¡æ˜¾ç¤º 10æ¡
        creatorId: '101', //é»˜è®¤ä¸º 101ç”¨æˆ· https://demo.usememos.com/u/101
        domId: '#memos', //é»˜è®¤ä¸º #memos
    }

</script>
<script>
    /*
Last Modified time : 20221021 21:32 by https://immmmm.com
*/
    var bbMemo = {
        memos: 'https://demo.usememos.com/',
        limit: '10',
        creatorId: '101',
        domId: '#memos',
    }
    if (typeof (bbMemos) !== "undefined") {
        for (var key in bbMemos) {
            if (bbMemos[key]) {
                bbMemo[key] = bbMemos[key];
            }
        }
    }

    var limit = bbMemo.limit
    var memos = bbMemo.memos
    var bbUrl = memos + "api/memo?creatorId=" + bbMemo.creatorId + "&rowStatus=NORMAL"
    var page = 1,
        offset = 0,
        nextLength = 0,
        nextDom = '';
    var bbDom = document.querySelector(bbMemo.domId);
    var load = '<button class="load-btn button-load">åŠªåŠ›åŠ è½½ä¸­â€¦â€¦</button>'
    if (bbDom) {
        bbDom.insertAdjacentHTML('afterend', load);
        getFirstList() //é¦–æ¬¡åŠ è½½æ•°æ®
        var btn = document.querySelector("button.button-load");
        btn.addEventListener("click", function () {
            btn.textContent = 'åŠªåŠ›åŠ è½½ä¸­â€¦â€¦';
            updateHTMl(nextDom)
            if (nextLength < limit) { //è¿”å›æ•°æ®æ¡æ•°å°äºé™åˆ¶æ¡æ•°ï¼Œéšè—
                document.querySelector("button.button-load").remove()
                return
            }
            getNextList()
        });
    }

    function getFirstList() {
        var bbUrl_first = bbUrl + "&limit=" + limit;
        fetch(bbUrl_first).then(res => res.json()).then(resdata => {
            updateHTMl(resdata.data)
            var nowLength = resdata.data.length
            if (nowLength < limit) { //è¿”å›æ•°æ®æ¡æ•°å°äº limit åˆ™ç›´æ¥ç§»é™¤â€œåŠ è½½æ›´å¤šâ€æŒ‰é’®ï¼Œä¸­æ–­é¢„åŠ è½½
                document.querySelector("button.button-load").remove()
                return
            }
            page++
            offset = limit * (page - 1)
            getNextList()
        });
    }
    //é¢„åŠ è½½ä¸‹ä¸€é¡µæ•°æ®
    function getNextList() {
        var bbUrl_next = bbUrl + "&limit=" + limit + "&offset=" + offset;
        fetch(bbUrl_next).then(res => res.json()).then(resdata => {
            nextDom = resdata.data
            nextLength = nextDom.length
            page++
            offset = limit * (page - 1)
            if (nextLength < 1) { //è¿”å›æ•°æ®æ¡æ•°ä¸º 0 ï¼Œéšè—
                document.querySelector("button.button-load").remove()
                return
            }
        })
    }
    // æ’å…¥ html
    function updateHTMl(data) {
        var bbResult = "",
            resultAll = "";

        for (var i = 0; i < data.length; i++) {
            // Marked Options
            marked.setOptions({
                breaks: true,
                smartypants: true,
                langPrefix: 'language-'
            });
            // Marked Image
            const renderer = {
                image(href, title, text) {
                    return `
                        <div class="gallery">
                            <a href="${href}"><img loading="lazy" class="img" src="${href}" alt="${text}"></a>
                        </div>`;
                    },
                code(code, infostring, escaped){
                    const language =  infostring ? infostring : 'none';
                    return `<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-${language}" data-lang="${language}">${code}</code></pre></div>`;
                }
            };
            const tagReg = {
                name: 'tagReg',
                level: 'inline',
                start(src) { return src.match(/#/)?.index; },
                tokenizer(src, tokens) {
                    const rule = /#([^\s#]+?) /;
                    const match = rule.exec(src);
                    if (match) {
                        return {
                            type: 'tagReg',
                            raw: match[0],
                            tagReg: this.lexer.inlineTokens(match[1].trim()),
                        };
                    }
                },
                renderer(token) {
                    return `<span class="tag-span"><a target="_blank" rel="noopener noreferrer" href="https://memos.eallion.com/u/101?tag=${this.parser.parseInline(token.tagReg)}">#${this.parser.parseInline(token.tagReg)}</a></span> `;
                }
            };

            marked.use({ extensions: [tagReg] });
            marked.use({ renderer });

            //console.log(data[i].content)
            var bbContREG = marked.parse(pangu.spacing(data[i].content))
            //console.log(bbContREG)

            //è§£æå†…ç½®èµ„æºæ–‡ä»¶
            if (data[i].resourceList && data[i].resourceList.length > 0) {
                var resourceList = data[i].resourceList;
                var imgUrl = '',
                    resUrl = '',
                    resImgLength = 0;
                for (var j = 0; j < resourceList.length; j++) {
                    var restype = resourceList[j].type.slice(0, 5);
                    if (restype == 'image') {
                        imgUrl += '<a href="'+ memos + 'o/r/' + resourceList[j].id + '/' + resourceList[j].filename +' "><img class="img thumbnail-image" src="' + memos + 'o/r/' + resourceList[j].id + '/' + resourceList[j].filename + '"/></a>'
                        resImgLength = resImgLength + 1
                    }
                    if (restype !== 'image') {
                        resUrl += '<a href="' + memos + 'o/r/' + resourceList[j].id + '/' + resourceList[j].filename + '" target="_blank" download="' + resourceList[j].filename + '">' + resourceList[j].filename + '</a>'
                    }
                }
                if (imgUrl) {
                    var resImgGrid = ""
                    if (resImgLength !== 1) {
                        var resImgGrid = "grid grid-" + resImgLength
                    }
                    bbContREG += '<div class="gallery ' + resImgGrid + '">' + imgUrl + '</div>'
                }
                if (resUrl) {
                    bbContREG += '<p class="datasource">' + resUrl + '</p>'
                }
            }
            bbResult += '<li class="timeline"><div class="talks__content"><div class="talks__text"><div class="talks__userinfo"><div>Charles Chin</div><div><svg viewBox="0 0 24 24" aria-label="è®¤è¯è´¦å·" class="talks__verify"><g><path d="M22.5 12.5c0-1.58-.875-2.95-2.148-3.6.154-.435.238-.905.238-1.4 0-2.21-1.71-3.998-3.818-3.998-.47 0-.92.084-1.336.25C14.818 2.415 13.51 1.5 12 1.5s-2.816.917-3.437 2.25c-.415-.165-.866-.25-1.336-.25-2.11 0-3.818 1.79-3.818 4 0 .494.083.964.237 1.4-1.272.65-2.147 2.018-2.147 3.6 0 1.495.782 2.798 1.942 3.486-.02.17-.032.34-.032.514 0 2.21 1.708 4 3.818 4 .47 0 .92-.086 1.335-.25.62 1.334 1.926 2.25 3.437 2.25 1.512 0 2.818-.916 3.437-2.25.415.163.865.248 1.336.248 2.11 0 3.818-1.79 3.818-4 0-.174-.012-.344-.033-.513 1.158-.687 1.943-1.99 1.943-3.484zm-6.616-3.334l-4.334 6.5c-.145.217-.382.334-.625.334-.143 0-.288-.04-.416-.126l-.115-.094-2.415-2.415c-.293-.293-.293-.768 0-1.06s.768-.294 1.06 0l1.77 1.767 3.825-5.74c.23-.345.696-.436 1.04-.207.346.23.44.696.21 1.04z"></path></g></svg></div><div class="talks__id">@eallion</div></div><p>' + bbContREG + '</p></div><div class="talks__meta"><small class="talks__date">' + moment(data[i].createdTs * 1000).twitter() + ' â€¢ æ¥è‡ªã€Œ<a href="https://memos.eallion.com/m/' + data[i].id + '" target="_blank">Memos</a>ã€</small></div></div></li>'
        } // end for
        var bbBefore = '<ul class="talks">'
        var bbAfter = '</ul>'
        resultAll = bbBefore + bbResult + bbAfter
        bbDom.insertAdjacentHTML('beforeend', resultAll);
        document.querySelector('button.button-load').textContent = 'åŠ è½½æ›´å¤š';
        //å›¾ç‰‡ç¯ç®±
        // baguetteBox ç¯ç®± Issue: #190 å…ˆé”€æ¯å†åˆå§‹åŒ–
        baguetteBox.destroy()
        baguetteBox.run('.gallery', {
            // Custom options
            buttons: false,
            noScrollbars: true,
            fullScreen: false,
            filter: /.*/i
        });
    }

</script>
<script>
    function clearInput() {
        const talkSearch = document.getElementById('talkSearch');
        talkSearch.value = '';
    }

</script>
{{ end }}
