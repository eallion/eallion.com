{{ define "main" }}
<!-- Include only the reset -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/reset-min.css" />
<!-- or include the full Satellite theme -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css" />
<div class="posts searchPage searchAlgolia">
    <div id="searchbox" class="searchboxAlgolia">
        <!-- SearchBox widget will appear here -->
    </div>
    <div id="hits" class="hitsAlgolia">
        <!-- Hits widget will appear here -->
    </div>
    <div id="pagination" class="paginationAlgolia">
        <!-- pagination widget will appear here -->
    </div>
</div>
<!-- Algolia for the search only version -->
<script src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4"></script>
<script src="https://cdn.staticfile.org/moment.js/2.29.2/moment.min.js"></script>
<script>
    const searchClient = algoliasearch(
        "ZHP6RM1ABL",
        "1d5887e05145f909a97929fe3d4f135a"
    );

    const search = instantsearch({
        indexName: "talk",
        searchClient,
    });

    // autocorrect: false
    moment.updateLocale('zh-cn', {
        meridiem : function (hour, minute, isLowercase) {
            if (hour < 6) {
                return "å‡Œæ™¨";
            } else if (hour < 9){
                return "æ—©ä¸Š";
            } else if (hour < 11 && minute < 30) {
                return "ä¸Šåˆ";
            } else if (hour < 13 && minute < 30) {
                return "ä¸­åˆ";
            } else if (hour < 18) {
                return "ä¸‹åˆ";
            } else {
                return "æ™šä¸Š";
            }
        }
    });

    // --- Define some custom helpers ---
    const hitTemplate = function (hit) {
        let date = "";
        if (hit.date) {
            date = moment(hit.date).format("a HH:mm Â· YYYYå¹´MMæœˆDDæ—¥ ");
        }
        const content = urlToLink(hit._highlightResult.content.value);
        const from = hit._highlightResult.from.value;

        //å›¾ç‰‡ç¯ç®±æ•ˆæœ
        $(".hitsAlgolia a[rel!=link]:has(img)").slimbox();

        // å›¾ç‰‡å’Œé“¾æ¥
        function urlToLink(str) {
            //å»é™¤<img>æ ‡ç­¾ï¼Œç•™ src é“¾æ¥
            var re_forimg =/\<[img|IMG].*?src=[\'|\"](https\:\/\/.*?(?:[\.jpg|\.jpeg|\.png|\.gif|\.webp|\.jfif|\.bmp]))[\'|\"].*?[\/]?>/g;
            str =str.replace(re_forimg,'$1');
            //å» ![]() æ ‡ç­¾ï¼Œç•™å›¾ç‰‡é“¾æ¥
            var re_formd = /^!\[(.*)\]\((.*)\)/g;
            str = str.replace(re_formd,'$2');
            //å¤„ç†å›¾ç‰‡é“¾æ¥ï¼Œæ·»åŠ  a æ ‡ç­¾å…±æ·»åŠ ç¯ç®±æ•ˆæœ
            var re_forpic =/\bhttps?:[^:<>"]*\/([^:<>"]*)(\.(jpe?g)|(png)|(jfif)|(bmp)|(webp))/g;
            str =str.replace(re_forpic,function (imgurl) {
            return "<a href='" + imgurl + "' rel='noopener noreferrer'><img loading='lazy' src='" + imgurl + "' ></a>";
            });
            //å¤šä¸ªæ¢è¡Œç¬¦æ›¿æ¢ä¸ºä¸€ä¸ª
            str = str.replace( /\n\n/g, "\n");
            //å¤„ç†æ™®é€šé“¾æ¥ï¼Œæ·»åŠ  a æ ‡ç­¾ä¾›è·³è½¬
            var re =/\bhttps?:\/\/(?!\S+(?:jpe?g|png|bmp|gif|webp|jfif|gif))\S+/g;
            str =str.replace(re,function (website) {
            return "ğŸ”—<a href='" + website + "' target='_blank' rel='noopener noreferrer'>é“¾æ¥</a>";
            });
            //å¾®ä¿¡è¡¨æƒ…
            // str = qqWechatEmotionParser(str)
            return str;
        }
        return `
            <section class="timeline">
                <p>${content}</p>
                <time class="date"><small>${date} Â·ã€Œ${from}ã€</small></time>
            </section>
        `;
    };
    // autocorrect: true

    search.addWidgets([
        instantsearch.widgets.searchBox({
            container: "#searchbox",
        }),

        instantsearch.widgets.hits({
            container: "#hits",
            attribute: "content",
            escapeHTML: false,
            templates: {
                empty: "æˆ‘æ²¡æœ‰è¿™æ ·çš„å˜€å’•â€¦â€¦",
                item: hitTemplate,
            },
        }),
        instantsearch.widgets.pagination({
            container: "#pagination",
            padding: 2,
            scrollTo: 'header'
        }),
    ]);

    search.start();

</script>

{{ end }}
